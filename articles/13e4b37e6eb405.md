---
title: "vuejs/language-tools ã® PR ã‚’èª­ã¿è§£ãï¼šDiffWindow ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆå•é¡Œ"
emoji: "ğŸ„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["vue", "vscode","typescript"]
published: true
publication_name: "comm_vue_nuxt"
---

ã“ã®è¨˜äº‹ã¯ã€ğŸ“… **[Vue Advent Calendar 2025](https://qiita.com/advent-calendar/2025/vue)** ã® 8 æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

## ã¯ã˜ã‚ã«

Visual Studio Codeï¼ˆä»¥ä¸‹ã€VS Codeï¼‰ã§ Vue.js ã‚’é–‹ç™ºã™ã‚‹éš›ã«ä¾¿åˆ©ãªæ‹¡å¼µæ©Ÿèƒ½ã§ã‚ã‚‹ Vue (Official) ã‚’åˆ©ç”¨ã•ã‚Œã‚‹å ´åˆãŒå¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

æœ¬æ—¥ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸ `v3.1.7` ã§æ°—ã«ãªã‚‹ä¿®æ­£ãŒã‚ã£ãŸã®ã§ã€å†ç¾ç¢ºèªã¨ã‚³ãƒŸãƒƒãƒˆã‚’è¿½ã£ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/vuejs/language-tools/releases/tag/v3.1.7

https://github.com/vuejs/language-tools/pull/5811

## vuejs/language-tools ã¨ã¯

ã¾ãšã€vuejs/language-tools ã«ã¤ã„ã¦ç°¡å˜ã«ç´¹ä»‹ã—ã¾ã™ã€‚

Vue.js ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€IDE ã‚µãƒãƒ¼ãƒˆã«ã¤ã„ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> The recommended IDE setup is VS Code + the Vue - Official extension (previously Volar). The extension provides syntax highlighting, TypeScript support, and intellisense for template expressions and component props.

https://vuejs.org/guide/scaling-up/tooling.html#ide-support

ã“ã® Vue - Official æ‹¡å¼µæ©Ÿèƒ½ã®ä¸­æ ¸ã¨ãªã‚‹ã®ãŒ [vuejs/language-tools](https://github.com/vuejs/language-tools) ã§ã™ã€‚

ä»¥ä¸‹ã®å›³ã®ã‚ˆã†ã«ã€è¤‡æ•°ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚ä»Šå›ã®ä¿®æ­£ã¯ `@vue/language-core` ã«é–¢ã™ã‚‹ã‚‚ã®ã§ã™ã€‚

![vuejs/language-tools ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](https://storage.googleapis.com/zenn-user-upload/bdc0d0cbf1b2-20251208.png)
*[Community Integration - vuejs/language-tools](https://github.com/vuejs/language-tools/blob/master/README.md#community-integration) ã‚ˆã‚Š*

## å•é¡Œï¼šGit å·®åˆ†è¡¨ç¤ºã§è‰²ãŒãŠã‹ã—ããªã‚‹

https://github.com/vuejs/language-tools/issues/5572

Git ã®å·®åˆ†è¡¨ç¤ºï¼ˆDiffWindowï¼‰ã§ Vue ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¨ã€Semantic Highlighting ãŒæ­£ã—ãé©ç”¨ã•ã‚Œãšã€ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã®è‰²ãŒå£Šã‚Œã¦ã—ã¾ã†ç¾è±¡ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚

æ‰‹å…ƒã§ã‚‚å†ç¾ç¢ºèªã‚’è¡Œã£ãŸã¨ã“ã‚å†ç¾ã—ã¾ã—ãŸã€‚å‚è€ƒã¾ã§ã«ç’°å¢ƒã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

- VS Code: 1.106.3 (Universal)
- Vue - Official (vue.volar): 3.0.7 ã‚ˆã‚Šå‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
- Vue: 3.5.25
- vue-tsc: 3.0.2

PR ã‚’è¦‹ã‚‹ã ã‘ã ã¨ç†è§£ãŒæ·±ã¾ã‚‰ãªã„ã®ã§ã€ãƒ•ã‚©ãƒ¼ã‚¯ã—ã¦å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã‚’ã„ã˜ã‚ŠãªãŒã‚‰ãƒ†ã‚¹ãƒˆã‚’å›ã—ã¦ã„ãã“ã¨ã«ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã¯æ¤œè¨¼ã«åˆ©ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰ãªã®ã§ã€èˆˆå‘³ã‚ã‚‹æ–¹ã¯æ‰‹å…ƒã§ã‚‚è©¦ã—ã¦èª­ã‚“ã§ã¿ã¦ãã ã•ã„ã€‚

:::details æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ã¨ãƒ­ã‚°å‡ºåŠ›

å®Ÿéš›ã« vuejs/language-tools ã‚’ãƒ•ã‚©ãƒ¼ã‚¯ã—ã€`packages/language-core/lib/languagePlugin.ts` ã«ãƒ­ã‚°å‡ºåŠ›ã‚’è¿½åŠ ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

https://github.com/vuejs/language-tools

```bash
pnpm exec vitest run packages/language-server/tests/semanticTokens.spec.ts
```

## å¤‰æ›´å‰ã®ãƒ­ã‚°

```bash
[å¤‰æ›´å‰] createVirtualCode {
  fileName: '/path/to/semanticTokens.vue',
  languageId: 'vue',
  scheme: 'file',
  registryKeys: []
}
[å¤‰æ›´å‰] cache hit: false
[å¤‰æ›´å‰] new code created, registering with key: /path/to/semanticTokens.vue

Opening git document with URI: git:/path/to/semanticTokens.vue

[å¤‰æ›´å‰] createVirtualCode {
  fileName: '/path/to/semanticTokens.vue',
  languageId: 'vue',
  scheme: 'git',
  registryKeys: [
    '/path/to/semanticTokens.vue'
  ]
}
[å¤‰æ›´å‰] cache hit: true  â† åŒã˜ã‚­ãƒ¼ãªã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆï¼ˆå•é¡Œï¼ï¼‰
```

`git://` ã‚¹ã‚­ãƒ¼ãƒ ã§ã‚‚ `fileName`ï¼ˆãƒ‘ã‚¹ï¼‰ãŒåŒã˜ãªã®ã§ `cache hit: true` ã¨ãªã‚Šã€`file://` ç”¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå†åˆ©ç”¨ã•ã‚Œã¾ã™ã€‚ãã®å¾Œ `code.update(snapshot)` ã§ Git ã®å†…å®¹ã«æ›´æ–°ã•ã‚Œã¦ã—ã¾ã„ã€å…ƒã® `file://` ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ±šæŸ“ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

#### è§£æ±ºç­–ï¼šscriptId ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†é›¢

PR #5811 ã§ã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ `scriptId`ï¼ˆURI å…¨ä½“ï¼‰ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚­ãƒ¼ãƒ ã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```typescript
// å¤‰æ›´å¾Œï¼šscriptId ã‚’ã‚­ãƒ¼ã«ä½¿ç”¨
fileRegistry.get(String(scriptId))
fileRegistry.set(String(scriptId), code)

disposeVirtualCode(scriptId) {
    fileRegistry.delete(String(scriptId));
}
// ã‚­ãƒ¼ä¾‹: 'file:///path/to/App.vue' ã¾ãŸã¯ 'git:/path/to/App.vue'
```

## å¤‰æ›´å¾Œã®ãƒ­ã‚°

```
[å¤‰æ›´å¾Œ] createVirtualCode {
  fileName: '/path/to/semanticTokens.vue',
  languageId: 'vue',
  scheme: 'file',
  scriptIdStr: 'file:///path/to/semanticTokens.vue',
  registryKeys: []
}
[å¤‰æ›´å¾Œ] cache hit: false
[å¤‰æ›´å¾Œ] new code created, registering with key: file:///path/to/semanticTokens.vue

Opening git document with URI: git:/path/to/semanticTokens.vue

[å¤‰æ›´å¾Œ] createVirtualCode {
  fileName: '/path/to/semanticTokens.vue',
  languageId: 'vue',
  scheme: 'git',
  scriptIdStr: 'git:/path/to/semanticTokens.vue',
  registryKeys: [
    'file:///path/to/semanticTokens.vue'
  ]
}
[å¤‰æ›´å¾Œ] cache hit: false  â† ç•°ãªã‚‹ã‚­ãƒ¼ãªã®ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒŸã‚¹ï¼ˆæ­£ã—ã„å‹•ä½œï¼‰
[å¤‰æ›´å¾Œ] new code created, registering with key: git:/path/to/semanticTokens.vue
```

`scriptId` ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ã“ã¨ã§ã€`file://` ã¨ `git://` ã§ç•°ãªã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªãŒä½¿ç”¨ã•ã‚Œã€äº’ã„ã«å¹²æ¸‰ã—ãªããªã‚Šã¾ã—ãŸã€‚

### æ¤œè¨¼ã«ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰

å‚è€ƒã¾ã§ã«ã€ãƒ­ã‚°ã‚’ä»•è¾¼ã‚“ã ã‚³ãƒ¼ãƒ‰ã‚’æ²è¼‰ã—ã¾ã™ã€‚

#### å¤‰æ›´å‰

```typescript:packages/language-core/lib/languagePlugin.ts
createVirtualCode(scriptId, languageId, snapshot) {
    const fileName = asFileName(scriptId);
    if (plugins.some(plugin => plugin.isValidFile?.(fileName, languageId))) {
        // [å¤‰æ›´å‰] fileName ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
        const code = fileRegistry.get(fileName);
        console.log('[å¤‰æ›´å‰] createVirtualCode', {
            fileName,
            languageId,
            scheme: (scriptId as any).scheme ?? 'unknown',
            registryKeys: [...fileRegistry.keys()]
        });
        console.log('[å¤‰æ›´å‰] cache hit:', !!code);
        if (code) {
            code.update(snapshot);
            return code;
        }
        else {
            const code = new VueVirtualCode(
                fileName,
                languageId,
                snapshot,
                vueCompilerOptions,
                plugins,
                ts,
            );
            console.log('[å¤‰æ›´å‰] new code created, registering with key:', fileName);
            fileRegistry.set(fileName, code);
            return code;
        }
    }
},
disposeVirtualCode(scriptId) {
    const fileName = asFileName(scriptId);
    fileRegistry.delete(fileName);
},
```

#### å¤‰æ›´å¾Œ

```typescript:packages/language-core/lib/languagePlugin.ts
createVirtualCode(scriptId, languageId, snapshot) {
    const fileName = asFileName(scriptId);
    if (plugins.some(plugin => plugin.isValidFile?.(fileName, languageId))) {
        // [å¤‰æ›´å¾Œ] String(scriptId) ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
        const code = fileRegistry.get(String(scriptId));
        console.log('[å¤‰æ›´å¾Œ] createVirtualCode', {
            fileName,
            languageId,
            scheme: (scriptId as any).scheme ?? 'unknown',
            scriptIdStr: String(scriptId),
            registryKeys: [...fileRegistry.keys()]
        });
        console.log('[å¤‰æ›´å¾Œ] cache hit:', !!code);
        if (code) {
            code.update(snapshot);
            return code;
        }
        else {
            const code = new VueVirtualCode(
                fileName,
                languageId,
                snapshot,
                vueCompilerOptions,
                plugins,
                ts,
            );
            console.log('[å¤‰æ›´å¾Œ] new code created, registering with key:', String(scriptId));
            fileRegistry.set(String(scriptId), code);
            return code;
        }
    }
},
disposeVirtualCode(scriptId) {
    fileRegistry.delete(String(scriptId));
},
```

:::

## åŸå› ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã®ç«¶åˆ

åŸå› ã¯ã€ä»®æƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã« `fileName`ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®ã¿ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ãŸã“ã¨ã«ã‚ã‚Šã¾ã™ã€‚

```typescript
// å¤‰æ›´å‰ï¼šfileName ã‚’ã‚­ãƒ¼ã«ä½¿ç”¨
fileRegistry.get(fileName)
fileRegistry.set(fileName, code)

// disposeVirtualCode ã‚‚åŒæ§˜
disposeVirtualCode(scriptId) {
    const fileName = asFileName(scriptId);
    fileRegistry.delete(fileName);
}
// ã‚­ãƒ¼ä¾‹: '/path/to/App.vue'
```

é€šå¸¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ `file://` ã‚¹ã‚­ãƒ¼ãƒ ã§ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã¾ã™ãŒã€Git ã®å·®åˆ†è¡¨ç¤ºã§ã¯ `git://` ã‚¹ã‚­ãƒ¼ãƒ ãŒä½¿ã‚ã‚Œã¾ã™ã€‚

- é€šå¸¸: `file:///path/to/App.vue`
- Gitå·®åˆ†: `git:/path/to/App.vue`

`fileName` ã ã‘ã‚’ã‚­ãƒ¼ã«ã™ã‚‹ã¨ã€ä¸¡è€…ãŒåŒã˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªã‚’å‚ç…§ã—ã¦ã—ã¾ã„ã€Git diff ãƒãƒƒãƒ•ã‚¡ãŒé€šå¸¸ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¸Šæ›¸ãã—ã¦ã—ã¾ã„ã¾ã™ã€‚

#### è§£æ±ºç­–ï¼šscriptId ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ†é›¢

PR #5811 ã§ã¯ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã‚’ `scriptId`ï¼ˆURI å…¨ä½“ï¼‰ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã§ã€ã‚¹ã‚­ãƒ¼ãƒ ã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

```typescript
// å¤‰æ›´å¾Œï¼šscriptId ã‚’ã‚­ãƒ¼ã«ä½¿ç”¨
fileRegistry.get(String(scriptId))
fileRegistry.set(String(scriptId), code)

disposeVirtualCode(scriptId) {
    fileRegistry.delete(String(scriptId));
}
// ã‚­ãƒ¼ä¾‹: 'file:///path/to/App.vue' ã¾ãŸã¯ 'git:/path/to/App.vue'
```

## ãŠã‚ã‚Šã«

æ—¥ã€…ãŠä¸–è©±ã«ãªã£ã¦ã„ã‚‹ Vue - Official æ‹¡å¼µæ©Ÿèƒ½ã®ä¸­æ ¸ã§ã‚ã‚‹ vuejs/language-tools ã®æ”¹å–„ã«ã‚ˆã‚Šã€Git å·®åˆ†è¡¨ç¤ºã§ã® Semantic Highlighting å•é¡ŒãŒè§£æ±ºã•ã‚Œã¾ã—ãŸã€‚

VS Code ã§ Vue.js ã‚’é–‹ç™ºã•ã‚Œã¦ã„ã‚‹æ–¹ã¯ã€ãœã²æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆv3.1.7 ä»¥é™ï¼‰ã¸ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¦ã¿ã¦ãã ã•ã„ã€‚

## å‚è€ƒãƒªãƒ³ã‚¯

- [PR #5811: feat(language-core): cache virtual code by scriptId](https://github.com/vuejs/language-tools/pull/5811)
- [Issue #5572: Different font colors in DiffWindow](https://github.com/vuejs/language-tools/issues/5572)
