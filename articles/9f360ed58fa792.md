---
title: "Laravel + jQueryã§ã‚µã‚¤ãƒˆå†…ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸš€"
type: "tech"
topics:
  - "jquery"
  - "laravel"
  - "ajax"
published: true
published_at: "2022-02-03 05:27"
---

# æ¦‚è¦

ä»Šå›ã¯`Ajax`ã‚’åˆ©ç”¨ã—ãŸã‚µã‚¤ãƒˆå†…ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã®å®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-02-03 0.15.29.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/9fb45609-f1b4-4fec-c70e-a0340103ea6c.png)

# ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ç”»é¢ä½œæˆ

```php:index.blade.php
<meta name="csrf-token" content="{{ csrf_token() }}">
<li>
    <div class="mb-3">
        <label class="form-label">
            <span class="icon_left">
                <i class="fas fa-search"></i>
                <a data-toggle="collapse" href="#collapseFavorite"><small>ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰æ¤œç´¢</small></a>
            </span>
        </label>
        <label class="collapse" id="collapseFavorite">
            <input type="checkbox" name="is_search_favorite"
                   value="1" {{$query->get('is_search_favorite') == 1 ? 'checked':null}}>
        </label>
    </div>
</li>
<div class="row">
    <div class="col-12 col-sm-6 col-md-6 col-lg-6 col-xl-6 mb-3">
        @php
            if (\Illuminate\Support\Facades\Session::has('favorite')) {
                $itemIds = array_filter(!is_null((\Illuminate\Support\Facades\Session::get('favorite'))) ? explode(',', (\Illuminate\Support\Facades\Session::get('favorite'))) : []);
            }
            else{
                $itemIds = [];
            }
        @endphp
        <button type="button"
                class="btn-favorite-icon btn btn-lg border border-secondary mb-3 ml-2 btn-block"
                style="background-color: #fefcf6" id="favorite_icon"
                data-id="{{$item->id}}">
            @if(!empty($itemIds) && in_array($item->id,$itemIds))
                <i class="fas fa-star icon-color" id="favorite-icon"></i>
            @else
                <i class="far fa-star" id="favorite-icon"></i>
            @endif
            <small>ãŠæ°—ã«å…¥ã‚Š</small>
        </button>
    </div>
</div>
```

## è§£èª¬

- POSTãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜ã—ã¾ã™

https://readouble.com/laravel/8.x/ja/csrf.html

```php
<meta name="csrf-token" content="{{ csrf_token() }}">
```

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ç¾åœ¨ãŠæ°—ã«å…¥ã‚Šã«ç™»éŒ²ã—ã¦ã„ã‚‹å•†å“IDã‚’å–å¾—ã—ã¾ã™

- `array_filter` :é…åˆ—å†…ã«ç©ºæ–‡å­—åˆ—ãŒå…¥ã‚‹å ´åˆç­‰ã‚’è€ƒæ…®ã—ã¦å‰Šé™¤ã—ã¾ã™
- `explode` : é…åˆ—ã‚’æ–‡å­—åˆ—ã«å¤‰æ›ã—ãŸã‚‚ã®ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ã®ã§é…åˆ—ã«å¤‰æ›ã™ã‚‹


```php
@php
    if (\Illuminate\Support\Facades\Session::has('favorite')) {
        $itemIds = array_filter(!is_null((\Illuminate\Support\Facades\Session::get('favorite'))) ? explode(',', (\Illuminate\Support\Facades\Session::get('favorite'))) : []);
    }
    else{
        $itemIds = [];
    }
@endphp
```

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãŠæ°—ã«å…¥ã‚Šæƒ…å ±ãŒå­˜åœ¨ã—ã¦ã„ã¦ã€å•†å“IDãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´ã—ã¾ã™

```php
@if(!empty($itemIds) && in_array($item->id,$itemIds))
    <i class="fas fa-star icon-color" id="favorite-icon"></i>
@else
    <i class="far fa-star" id="favorite-icon"></i>
@endif
```

# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å®šç¾©ã—ã¾ã™

https://readouble.com/laravel/8.x/ja/routing.html

```php
<?php

use Illuminate\Support\Facades\Route;

Route::post('/set_session/favorite', 'IndexControll@setSession');
```

# ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå¾Œã®å‡¦ç†ã‚’è¿½åŠ 

```js:index.js
$('[id=favorite_icon]').on('click', function () {
    const id = $(this).data('id');
    const icon = $(this).children('i');
    $.ajaxSetup({
        headers: {
            "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content"),
        },
    });

    $.ajax(
        {
            url: "/set_session/favorite",
            type: "POST",
            data: {
                "item_id": id
            },
            dataType: 'json',
            complete: function (res) {
                if (res.responseJSON.status) {
                    const ids = (res.responseJSON.ids).split(',');

                    if (jQuery.inArray(String(id), ids) !== -1) {
                        icon.removeClass('far fa-star');
                        icon.addClass('fas fa-star icon-color');
                    } else {
                        icon.removeClass('fas fa-star icon-color');
                        icon.addClass('far fa-star');
                    }
                } else {
                    alert('äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                }
            }
        }
    )
});
```

##ã€€è§£èª¬

- åŒã˜IDã‚’è¤‡æ•°æŒã¤è¦ç´ å…¨ã¦ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¾ã™

```js
$('[id=favorite_icon]').on('click', function () {}
```

``data-id="{{$item->id}}"`ã§æŒ‡å®šã—ã¦ã„ã‚‹å•†å“IDã‚’`data`å±æ€§ã‹ã‚‰å–å¾—ã—ã¾ã™

```js
const id = $(this).data('id');
```

- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã«è¨­å®šã—ã¾ã™

https://readouble.com/laravel/8.x/ja/csrf.html

```js
$.ajaxSetup({
    headers: {
        "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("conte

https://www.flatflag.nir87.com/split-2178

```js
const ids = (res.responseJSON.ids).split(',');
```

- `jQuery.inArray`ã§é…åˆ—å†…ã«ã‚¢ã‚¤ãƒ†ãƒ IDãŒå­˜åœ¨ã™ã‚‹å ´åˆã«ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã¾ã™

- `inArray`ã®æˆ»ã‚Šå€¤ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯`-1`ã‚’è¿”ã™ä»•æ§˜ä¸Šä»¥ä¸‹æ¡ä»¶ã§åˆ†å²ã—ã¾ã™
- `String(id)`ã§é…åˆ—å†…ã®è¦ç´ ãŒ`String`å‹ã®ãŸã‚å‹ã‚’åˆã‚ã›ã‚‹ãŸã‚ã«`INTå‹`ã‹ã‚‰å¤‰æ›ã—ã¾ã™

```js
if (jQuery.inArray(String(id), ids) !== -1) {
    icon.removeClass('far fa-star');
    icon.addClass('fas fa-star icon-color');
} else {
    icon.removeClass('fas fa-star icon-color');
    icon.addClass('far fa-star');
}
```

# ãŠæ°—ã«å…¥ã‚Šç™»éŒ²ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ§‹ç¯‰

```php:IndexControll.php
<?php

namespace App\Http\Controllers;

class IndexController extends Controller
{
   /**
     * ãŠæ°—ã«å…¥ã‚Šã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿æŒã™ã‚‹
     * @param Request $request
     * @return JsonResponse
     */
    public function setSession(Request $request): JsonResponse
    {
        try {
            $itemId = $request->input('item_id');
            $offerIds = null;
	    
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ä¿æŒã—ãŸå€¤ã‚’é…åˆ—ã«å¤‰æ›ã™ã‚‹
            if (Session::has('favorite')) {
                $itemIds = !is_null(Session::get('favorite')) ? explode(',', Session::get('favorite')) : [];
            }
	    
	    // ãŠæ°—ã«å…¥ã‚Šã«1ä»¶ã‚‚ãªã‘ã‚Œã°ã¨ã‚Šã‚ãˆãšä¿å­˜ã™ã‚‹
            if (empty($itemIds)) {
                $itemIds[] = $itemId;
            }

            // ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã«å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ ãƒ»å­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
            if (!in_array($itemId, $itemIds)) {
                $itemIds[] = $itemId;
            } else {
                $index = array_search($itemId, $itemIds);
                unset($itemIds[$index]);
            }

            //ã€€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
            Session::forget('favorite');
            Session::put(['favorite' => implode(',', $itemIds)]);

            return response()->json([
                'status' => true,
                'ids' => Session::get('favorite'),
                'id' => $itemId,
                'message' => 'success',
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'status' => false,
                'message' => $e->getMessage(),
            ]);
        }
    }
}
```

ä»¥ä¸‹ã®ã‚ˆã†ãªå‹•ãã«ãªã‚Šã¾ã™
ã¾ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¦ã„ã‚‹ã®ã§ãƒšãƒ¼ã‚¸ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸå ´åˆã‚‚ä¿æŒã§ãã¾ã™

![video.gif](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/b13a656b-13b5-0309-8391-b34412f29202.gif)




# ã¾ã¨ã‚

ä»Šå›ã¯ã‚µã‚¤ãƒˆå†…ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã—ãŸ
ã„ã„ã­ã—ã¦ã„ãŸã ã‘ã‚‹ã¨è¨˜äº‹åŸ·ç­†ã®åŠ±ã¿ã«ãªã‚Šã¾ã™ã®ã§ã€å‚è€ƒã«ãªã£ãŸã¨æ€ã£ãŸæ–¹ã¯æ˜¯éã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼
