---
title: "ã€NestJS + Jestã€‘NestJSã§CIç’°å¢ƒæ§‹ç¯‰ãƒãƒ³ã‚ºã‚ªãƒ³"
emoji: "ğŸ—‚ï¸"
type: "tech"
topics:
  - "githubactions"
  - "ci"
  - "jest"
  - "nestjs"
published: true
published_at: "2022-03-29 01:00"
---

# æ¦‚è¦

å‹‰å¼·ä¼šç”¨ã®NestJSãƒãƒ³ã‚ºã‚ªãƒ³è³‡æ–™ã‚’ä½œã‚‹éç¨‹ã§è‰²ã€…æ•´ç†ã—ã¦ã¿ãŸ


# CIã£ã¦ä½•ï¼Ÿ

## CI ç¶™ç¶šçš„ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

> é–‹ç™ºè€…ãŒè‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’å®šæœŸçš„ã«ã‚»ãƒ³ãƒˆãƒ©ãƒ«ãƒªãƒã‚¸ãƒˆãƒªã«ãƒãƒ¼ã‚¸ã—ã€ãã®å¾Œã«è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ“ãƒ«ãƒ‰ã¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ DevOps ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢é–‹ç™ºã®æ‰‹æ³•

https://aws.amazon.com/jp/devops/continuous-integration/#:~:text=%E7%B6%99%E7%B6%9A%E7%9A%84%E3%82%A4%E3%83%B3%E3%83%86%E3%82%B0%E3%83%AC%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AF%E3%80%81%E9%96%8B%E7%99%BA,%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E6%89%8B%E6%B3%95%E3%81%A7%E3%81%99%E3%80%82

# å‰ææ¡ä»¶
- MacåŸºæº–ã§æ§‹æˆã—ã¦ã„ã¾ã™ã®ã§Windowsç’°å¢ƒã ã¨å‹•ä½œã—ãªã„å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã”äº†æ‰¿ãã ã•ã„
- ã‚¨ãƒ‡ã‚£ã‚¿ã¯ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†æ™‚ã«ãŠå¥½ã¿ã®ã‚‚ã®ã§é–‹ã„ã¦ä½œæ¥­ãã ã•ã„


# æ§‹ç¯‰ç’°å¢ƒã€ä½¿ç”¨æŠ€è¡“

## Node.js v14.15.4

- ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã®JavaScriptå®Ÿè¡Œç’°å¢ƒã‚„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰JavaScriptã®é–‹ç™ºç’°å¢ƒã¨ã—ã¦åˆ©ç”¨ã•ã‚Œã‚‹

https://nodejs.org/ja/

https://qiita.com/non_cal/items/a8fee0b7ad96e67713eb

## TypeORM ^8.0.3

- TypeScriptç”¨ã®ORãƒãƒƒãƒ‘ãƒ¼

https://typeorm.io/

## NestJS

- åŠ¹ç‡çš„ã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªNode.jsã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

https://nestjs.com/

## MySQL 8.0

- ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

https://hub.docker.com/_/mysql

https://www.mysql.com/jp

## Jest

- JavaScriptã®ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

https://jestjs.io/ja/


# äº‹å‰æº–å‚™

- Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª

https://docs.docker.com/desktop/mac/install/

```bash
docker --version                                                                                     
Docker version 20.10.13, build a224086
```

# ä»Šå›ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã®ã‚´ãƒ¼ãƒ«

- NestJSãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹ç¯‰
- MySQLç’°å¢ƒã‚’Dockerã§æ§‹ç¯‰
- CRUDæ©Ÿèƒ½ã®å®Ÿè£…
- E2Eãƒ†ã‚¹ãƒˆã®å®Ÿè£…
- GitHubActionsã§E2Eãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•åŒ–ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹


## ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§NestJSãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

```bash:/Desktop/Practice
npm i -g @nestjs/cli
nest new meetUpDev

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ã¯NPMã§è¡Œã„ã¾ã™
? Which package manager would you â¤ï¸  to use?

ğŸš€  Successfully created project meet-up-dev
ğŸ‘‰  Get started with the following commands:

$ cd meet-up-dev
$ npm run start
```

## æœ€çµ‚çš„ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```bash
â”œâ”€â”€ ormconfig.test.ts
â”œâ”€â”€ ormconfig.ts
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ config
â”‚Â Â  â”‚Â Â  â””â”€â”€ configuration.ts
â”‚Â Â  â”œâ”€â”€ controllers
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.controller.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ users.controller.ts
â”‚Â Â  â”œâ”€â”€ database
â”‚Â Â  â”‚Â Â  â””â”€â”€ migrations
â”‚Â Â  â”œâ”€â”€ databases
â”‚Â Â  â”‚Â Â  â””â”€â”€ migrations
â”‚Â Â  â”‚Â Â      â””â”€â”€ 1648319214540-user.ts
â”‚Â Â  â”œâ”€â”€ demo.http
â”‚Â Â  â”œâ”€â”€ dto
â”‚Â Â  â”‚Â Â  â””â”€â”€ create-user.dto.ts
â”‚Â Â  â”œâ”€â”€ entities
â”‚Â Â  â”‚Â Â  â””â”€â”€ user.entity.ts
â”‚Â Â  â”œâ”€â”€ main.ts
â”‚Â Â  â”œâ”€â”€ modules
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ app.module.ts
â”‚Â Â  â”‚Â Â  â””â”€â”€ users.module.ts
â”‚Â Â  â””â”€â”€ services
â”‚Â Â      â”œâ”€â”€ app.service.ts
â”‚Â Â      â””â”€â”€ users.service.ts
â”œâ”€â”€ test
â”‚Â Â  â”œâ”€â”€ jest-e2e.json
â”‚Â Â  â””â”€â”€ user.e2e-spec.ts
â”œâ”€â”€ tsconfig.build.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ unit-test.yml
```

## ãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ

https://github.com/new

å¿…è¦ã«å¿œã˜ã¦å…ˆç¨‹ä½œæˆã—ãŸãƒªãƒ¢ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„

# NestJSãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èµ·å‹•ã™ã‚‹

```bash:/Desktop/Practice/meet-up-dev
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ node_modules ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
npm i 

# ã‚³ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹
npm run start:dev

[2:39:33 PM] Found 0 errors. Watching for file changes.

# èµ·å‹•ã§ãã¾ã—ãŸï¼
[Nest] 10374  - 03/26/2022, 2:39:34 PM     LOG [NestFactory] Starting Nest application...
[Nest] 10374  - 03/26/2022, 2:39:34 PM     LOG [InstanceLoader] AppModule dependencies initialized +35ms
[Nest] 10374  - 03/26/2022, 2:39:34 PM     LOG [RoutesResolver] AppController {/}: +11ms
[Nest] 10374  - 03/26/2022, 2:39:34 PM     LOG [RouterExplorer] Mapped {/, GET} route +2ms
[Nest] 10374  - 03/26/2022, 2:39:34 PM     LOG [NestApplication] Nest application successfully started +1ms
```

## ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹

```bash
curl -X GET --location "http://localhost:3000"

# Hello World!ã¨è¡¨ç¤ºã•ã‚Œã‚Œã°OKã§ã™
```

# Hello World!ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’è§£èª¬

https://zenn.dev/morinokami/articles/nestjs-overview

https://docs.nestjs.com/first-steps

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ« `main.ts`

> ã‚³ã‚¢é–¢æ•°NestFactoryã‚’ä½¿ç”¨ã—ã¦Nestã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

```ts:src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';

async function bootstrap() {
  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç”Ÿæˆ
  const app = await NestFactory.create(AppModule);

  // http://localhost:3000 ã§èµ·å‹•
  await app.listen(3000);
}

bootstrap();
```

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚ `app.module.ts`

> ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€‚

```ts:/src/modules/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from '../controllers/app.controller';
import { AppService } from '../services/app.service';

@Module({
  // Moduleã§ä½¿ç”¨ã™ã‚‹Providerã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ä»–ã®Module
  imports: [],

  // ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹å¿…è¦ã®ã‚ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ã‚»ãƒƒãƒˆ
  controllers: [AppController],

  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã§å…±æœ‰ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€
  providers: [AppService],
})
export class AppModule {}
```

## å˜ä¸€ãƒ«ãƒ¼ãƒˆã‚’æŒã¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆæƒ…å ±ã‚’å—ã‘å–ã‚Šé©åˆ‡ãªã‚µãƒ¼ãƒ“ã‚¹ã«å‡¦ç†ã‚’æŒ¯ã‚Šåˆ†ã‘ï¼ˆãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰ã—ã¾ã™


```ts:src/controllers/app.controller.ts
import { Controller, Get } from '@nestjs/common';
import { AppService } from '../services/app.service';
// ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å®šç¾©
@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
```

## å˜ä¸€ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤åŸºæœ¬çš„ãªã‚µãƒ¼ãƒ“ã‚¹

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰æ¸¡ã•ã‚Œã‚‹å‘½ä»¤ã‚’å—ã‘ã¦ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™


```ts:src/services/app.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
```

# `MySQL`ã‚³ãƒ³ãƒ†ãƒŠã‚’æ§‹ç¯‰

- Docker for Macv3.4.0 ä»¥ä¸Šã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã„ã¦ãã ã•ã„

https://www.docker.com/products/docker-desktop

https://qiita.com/yuta-ushijima/items/d3d98177e1b28f736f04


```yml:meet-up-dev/docker-compose.yml
# docker-composeã§ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å®šç¾©
version: '3'

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ãŸã‚ã®å„è¦ç´ 
services:
  # ã‚µãƒ¼ãƒ“ã‚¹å
  db:
    # ä½¿ç”¨ã™ã‚‹DockerImage
    image: mysql:8.
    # Dockerã®å…¬å¼MySQLã®æ–‡å­—ã‚³ãƒ¼ãƒ‰ã‚’utf8mb4ã«ã™ã‚‹
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    # ã‚³ãƒ³ãƒ†ãƒŠã®åå‰
    container_name: meetup_db_container
    # ãƒã‚¦ãƒ³ãƒˆã™ã‚‹è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
    volumes:
      - mysql-data-volume:/var/lib/mysql
    # ãƒãƒ¼ãƒˆç•ªå·
    ports:
      - "3306:3306"
    environment:
      TZ: 'Asia/Tokyo'
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: meetup
      MYSQL_USER: app
      MYSQL_PASSWORD: secret

# ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–
volumes:
  mysql-data-volume:
```

## ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹

```bash
docker compose up -d --build

docker compose ps    
NAME                  COMMAND                  SERVICE             STATUS              PORTS
meetup_db_container   "docker-entrypoint.sâ€¦"   db                  running             0.0.0.0:3306->3306/tcp

# ã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‹ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†
docker-compose exec db bash                                                               
root@6481e016e7a8:/# mysql -u root -p
# password
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or \g.
```

# `TypeORM`ã«å¿…è¦ãªè¨­å®šã‚’è¡Œã†

https://docs.nestjs.com/techniques/database

## å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install --save @nestjs/typeorm typeorm@0.2 mysql2
npm i --save @nestjs/config
```

## æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã™ã‚‹

https://docs.nestjs.com/techniques/configuration#custom-configuration-files

```ts:src/config/configuration.ts
export default () => ({
  // Nodeå®Ÿè¡Œæ™‚ã®ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¾ã™
  nodeEnv: process.env.NODE_ENV || 'development',
  server: {
    port: parseInt(process.env.PORT) || 3000,
    hostName: process.env.hostname || 'localhost:3000',
  },
  database: {
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT) || 3306,
    user: process.env.DB_USERNAME || 'root',
    pass: process.env.DB_PASSWORD || 'password',
    name: process.env.DB_NAME || 'meetup',
  },
});
```

## `TypeOrmModule`ã‚’`import`ã™ã‚‹

https://docs.nestjs.com/techniques/database#async-configuration

```diff_typescript:src/modules/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from '../controllers/app.controller';
import { AppService } from '../services/app.service';
import { join } from 'path';
+ import { ConfigModule, ConfigService } from '@nestjs/config';
+ import { TypeOrmModule } from '@nestjs/typeorm';
+ import configuration from '../config/configuration';

@Module({
  // Moduleã§ä½¿ç”¨ã™ã‚‹Providerã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ä»–ã®Module
  imports: [
+    ConfigModule.forRoot({
+      // ä»–ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚‚ä½¿ç”¨ã™ã‚‹
+      isGlobal: true,
+      // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
+      load: [configuration],
+    }),
+    // TypeORMã‚’æ§‹æˆã™ã‚‹
+    TypeOrmModule.forRootAsync({
+      imports: [ConfigModule],
+      useFactory: (configService: ConfigService) => ({
+        type: 'mysql',
+        host: configService.get('database.host'),
+        port: Number(configService.get('database.port')),
+        username: configService.get('database.user'),
+        password: configService.get('database.pass'),
+        database: configService.get('database.name'),
+        entities: [join(__dirname, '../entities/*.entity.{ts,js}')],
+        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã—ãªã„ https://stackoverflow.com/questions/65222981/typeorm-synchronize-in-production
+        synchronize: false,
+        logging: configService.get('nodeEnv') === 'development',
+        extra: {},
+      }),
+      inject: [ConfigService],
+    }),
+  ],

  // ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹å¿…è¦ã®ã‚ã‚‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ã®ã‚»ãƒƒãƒˆ
  controllers: [AppController],

  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å…¨ä½“ã§å…±æœ‰ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€
  providers: [AppService],
})
export class AppModule {}
```

# ç°¡æ˜“çš„ãªCRUDæ©Ÿèƒ½ã‚’å®Ÿè£…

> CRUD Createï¼ˆç™»éŒ²ï¼‰ã€Readï¼ˆå‚ç…§ï¼‰ã€Updateï¼ˆæ›´æ–°ï¼‰ã€Deleteï¼ˆå‰Šé™¤ï¼‰æ©Ÿèƒ½ã‚’ã¾ã¨ã‚ãŸè¡¨ç¾

https://docs.nestjs.com/recipes/crud-generator

```bash
nest g resource

? What name would you like to use for this resource (plural, e.g., "users")? users
# ä»Šå›ã¯REST APIã‚’æ§‹ç¯‰ã—ã¾ã™
? What transport layer do you use? REST API
? Would you like to generate CRUD entry points? Yes

# å¿…è¦ãªé››å½¢ãŒç”Ÿæˆã•ã‚Œã‚‹
ls src/users  
dto                      users.controller.spec.ts users.module.ts          users.service.ts
entities                 users.controller.ts      users.service.spec.ts
```

## `Entity`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹

https://docs.nestjs.com/techniques/database

https://zenn.dev/naonao70/articles/f0399d2baf05cc

```ts:src/users/entities/user.entity.ts
import {
  Column,
  CreateDateColumn,
  DeleteDateColumn,
  Entity,
  PrimaryGeneratedColumn,
  Timestamp,
  UpdateDateColumn,
} from 'typeorm';

@Entity('users')
export class User {
  // ä¸»ã‚­ãƒ¼ã‚’å®šç¾©
  @PrimaryGeneratedColumn({
    name: 'id',
    unsigned: true,
    type: 'bigint',
    comment: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID',
  })
  readonly id: number;

  @Column({
    type: 'varchar',
    length: 255,
    comment: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å',
  })
  name: string;

  @Column({
    type: 'varchar',
    length: 255,
    comment: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹',
    unique: true,
  })
  email: string;

  @Column({
    type: 'varchar',
    length: 255,
    comment: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
  })
  password: string;

  @CreateDateColumn({ comment: 'ç™»éŒ²æ—¥æ™‚' })
  readonly ins_ts?: Timestamp;

  @UpdateDateColumn({ comment: 'æœ€çµ‚æ›´æ–°æ—¥æ™‚' })
  readonly upd_ts?: Timestamp;

  @DeleteDateColumn({ comment: 'å‰Šé™¤æ—¥æ™‚' })
  readonly delete_ts?: Timestamp;

  constructor(name: string, email: string, password: string) {
    this.name = name;
    this.email = email;
    this.password = password;
  }
}
```

## `TypeORM`ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã™ã‚‹

- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã—ãªã„ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™

https://github.com/nestjs/nest/issues/4

```bash
No connection options were found in any orm configuration files.
```

```ts:ormconfig.ts
module.exports = {
  type: 'mysql',
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || '3306',
  username: process.env.DB_USERNAME || 'root',
  password: process.env.DB_PASSWORD || 'password',
  database: process.env.DB_NAME || 'meetup',
  // æ‰‹å‹•ã§ä½œæˆã—ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã¹ã¦ç®¡ç†ã™ã‚‹ã®ã§False
  synchronize: false,
  logging: true,
  entities: ['src/entities/*.ts'],
  migrations: ['src/databases/migrations/*.ts'],
  seeds: ['src/databases/seeders/*.seed.{js,ts}'],
  factories: ['src/databases/factories/*.factory.{js,ts}'],
  cli: {
    migrationsDir: 'src/databases/migrations',
    entitiesDir: 'src/entities',
    seedersDir: 'src/databases/seeders',
    factoriesDir: 'src/databases/factories',
  },
};
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ

```bash
npm run build

npx ts-node ./node_modules/.bin/typeorm migration:generate --name user

Migration /Desktop/Practice/meet-up-dev/src/databases/migrations/1648319214540-user.ts has been generated successfully.
```

### ä½œæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ

```bash
# ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
npm run build

npx ts-node ./node_modules/.bin/typeorm migration:run

query: START TRANSACTION
query: CREATE TABLE `users` (`id` bigint UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ID', `name` varchar(255) NOT NULL COMMENT 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å', `email` varchar(255) NOT NULL COMMENT 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', `password` varchar(255) NOT NULL COMMENT 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', `ins_ts` datetime(6) NOT NULL COMMENT 'ç™»éŒ²æ—¥æ™‚' DEFAULT CURRENT_TIMESTAMP(6), `upd_ts` datetime(6) NOT NULL COMMENT 'æœ€çµ‚æ›´æ–°æ—¥æ™‚' DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6), `delete_ts` datetime(6) NULL COMMENT 'å‰Šé™¤æ—¥æ™‚', UNIQUE INDEX `IDX_97672ac88f789774dd47f7c8be` (`email`), PRIMARY KEY (`id`)) ENGINE=InnoDB
query: INSERT INTO `meetup`.`migrations`(`timestamp`, `name`) VALUES (?, ?) -- PARAMETERS: [1648319214540,"user1648319214540"]
Migration user1648319214540 has been executed successfully.
query: COMMIT
```

`users`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™

```sql
show tables;
+------------------+
| Tables_in_meetup |
+------------------+
| migrations       |
| users            |
+------------------+
2 rows in set (0.00 sec)
```

## `Module`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹

```ts:src/modules/users.module.ts
import { Module } from '@nestjs/common';
import { UsersService } from '../services/users.service';
import { UsersController } from '../controllers/users.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../entities/user.entity';

@Module({
  // ç¾åœ¨ã®ã‚¹ã‚³ãƒ¼ãƒ—ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã‚’å®šç¾©ã™ã‚‹
  imports: [TypeOrmModule.forFeature([User])],
  controllers: [UsersController],
  providers: [UsersService],
})
export class UsersModule {}
```

## `Dto`ã‚¯ãƒ©ã‚¹ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®šç¾©

### å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm i --save class-validator class-transformer
```

https://docs.nestjs.com/techniques/validation

https://github.com/typestack/class-validator


```ts:src/dto/create-user.dto.ts
import {
  IsEmail,
  IsNotEmpty,
  IsOptional,
  Matches,
  MaxLength,
} from 'class-validator';
import { PartialType } from '@nestjs/mapped-types';

export class CreateUserDto {
  @IsNotEmpty({ message: 'åå‰ã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„' })
  @MaxLength(255, {
    message: 'åå‰ã¯255æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
  })
  name: string;

  @IsNotEmpty({ message: 'Emailã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„' })
  @MaxLength(255, {
    message: 'Emailã¯255æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„',
  })
  @IsEmail({ message: 'æ­£ã—ã„Emailå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„' })
  email: string;

  @IsNotEmpty({ message: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„` })
  @Matches(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,25}$/, {
    message: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’å«ã‚€8æ–‡å­—ä»¥ä¸Šï¼’ï¼•æ–‡å­—ä»¥å†…ã§è¨­å®šã—ã¦ãã ã•ã„`,
  })
  password: string;
}

export class UpdateUserDto extends PartialType(CreateUserDto) {
  // å€¤ãŒNULLãªã‚‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡è¦–ã™ã‚‹
  @IsOptional()
  @Matches(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,25}$/, {
    message: `ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤§æ–‡å­—å°æ–‡å­—ã‚’å«ã‚€8æ–‡å­—ä»¥ä¸Šï¼’ï¼•æ–‡å­—ä»¥å†…ã§è¨­å®šã—ã¦ãã ã•ã„`,
  })
  password: string;
}

```

## `Controller`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹

```ts:src/controllers/users.controller.ts
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  Patch,
  Post,
} from '@nestjs/common';
import { UsersService } from '../services/users.service';
import { CreateUserDto, UpdateUserDto } from '../dto/create-user.dto';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  create(@Body() createUserDto: CreateUserDto) {
    return this.usersService.create(createUserDto);
  }

  @Get()
  findAll() {
    return this.usersService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.usersService.findOne(+id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateUserDto: UpdateUserDto) {
    return this.usersService.update(+id, updateUserDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.usersService.remove(+id);
  }
}
```

## `Service`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹ãŸã‚ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™

```bash
npm i bcrypt
npm i -D @types/bcrypt
```

https://docs.nestjs.com/security/encryption-and-hashing

```ts:src/services/users.service.ts
import {
  BadRequestException,
  Injectable,
  InternalServerErrorException,
} from '@nestjs/common';
import { CreateUserDto, UpdateUserDto } from '../dto/create-user.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from '../entities/user.entity';
import { Not, Repository } from 'typeorm';
import * as bcrypt from 'bcrypt';

@Injectable()
export class UsersService {
  constructor(
    // Entityã‚’DIã™ã‚‹ã“ã¨ã§Repositoryã‚’çµŒç”±ã—ã¦DBã«å•ã„åˆã‚ã›ã‚’è¡Œã†
    @InjectRepository(User)
    private usersRepository: Repository<User>,
  ) {}

  /**
   * ç™»éŒ²
   * @param createUserDto
   */
  async create(createUserDto: CreateUserDto): Promise<{ message: string }> {
    if (
      (await this.usersRepository.find({ email: createUserDto.email })).length
    ) {
      throw new BadRequestException('æ—¢ã«ç™»éŒ²ãšã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™');
    }

    await this.usersRepository
      .save({
        name: createUserDto.name,
        email: createUserDto.email,
        password: await bcrypt.hash(createUserDto.password, 10),
      })
      .catch((e) => {
        throw new InternalServerErrorException(
          `[${e.message}]ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
        );
      });

    return { message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ã«æˆåŠŸã—ã¾ã—ãŸ' };
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
   */
  async findAll(): Promise<User[]> {
    return this.usersRepository.find();
  }

  /**
   * @description IDã«è©²å½“ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
   * @param id
   */
  async findOne(id: number): Promise<User> {
    return this.usersRepository.findOneOrFail(id);
  }

  /**
   * æ›´æ–°
   * @param id
   * @param updateUserDto
   */
  async update(
    id: number,
    updateUserDto: UpdateUserDto,
  ): Promise<{ message: string }> {
    if (
      (
        await this.usersRepository.find({
          email: updateUserDto.email,
          id: Not(id),
        })
      ).length
    ) {
      throw new BadRequestException('æ—¢ã«ç™»éŒ²ãšã¿ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™');
    }

    const baseUser = await this.usersRepository.findOneOrFail(id);

    await this.usersRepository
      .update(id, {
        name: updateUserDto.name,
        email: updateUserDto.email,
        password: updateUserDto.password
          ? await bcrypt.hash(updateUserDto.password, 10)
          : baseUser.password,
      })
      .catch((e) => {
        throw new InternalServerErrorException(
          `[${e.message}]ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${id}ã€ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
        );
      });

    return { message: `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${id}ã€ã®æ›´æ–°ã«æˆåŠŸã—ã¾ã—ãŸã€‚` };
  }

  /**
   * å‰Šé™¤
   * @param id
   */
  async remove(id: number) {
    await this.usersRepository.delete(id).catch((e) => {
      throw new InternalServerErrorException(
        `[${e.message}]ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${id}ã€ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`,
      );
    });
    return { message: `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${id}ã€ã®å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚` };
  }
}
```

# ä½œæˆã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹

```bash
# ç™»éŒ²
curl -X POST -H "Content-Type:application/json" localhost:3000/users -d '{"name": "ã»ã’", "email": "example@co.jp", "password": "Password1234"}'   

curl -X POST -H "Content-Type:application/json" localhost:3000/users -d '{"name": "ã»ã’2", "email": "example2@co.jp", "password": "Password1234"}'   

# æ›´æ–°
curl -X PATHC -H "Content-Type:application/json" localhost:3000/users/2 -d '{"name": "ãµãŒ", "email": "example2@co.jp", "password": "Password1234"}' 

# ä¸€è¦§
curl -X GET --location "http://localhost:3000/users"

# è©³ç´°
curl -X GET --location "http://localhost:3000/users/2"

# å‰Šé™¤
curl -X DELETE --location "http://localhost:3000/users/2"
```

# `E2Eãƒ†ã‚¹ãƒˆ`ã®å®Ÿè£…

https://qiita.com/mt0m/items/7e18d8802843d9f60d28#E2E%E3%83%86%E3%82%B9%E3%83%88%E3%81%A8%E3%81%AF

> E2E(End to End)Testã¯ã€User Interface Testã¨ã‚‚å‘¼ã°ã‚Œã€ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’é€šã—ã¦ãƒ†ã‚¹ãƒˆã‚’ãŠã“ãªã„ã¾ã™ã€‚
Webã‚µãƒ¼ãƒ“ã‚¹ã®å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ã¨åŒã˜ã‚ˆã†ã«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ“ä½œã—ã€æŒ™å‹•ãŒæœŸå¾…é€šã‚Šã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚


## ãƒ†ã‚¹ãƒˆç”¨`TypeORM`è¨­å®šã‚’å®šç¾©

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•ã§è¡Œã†æ©Ÿèƒ½ãŒç„¡ã„ã®ã§ãƒ†ã‚¹ãƒˆæ™‚ã®ã¿Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã—ã¾ã™

```ts
//  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã™ã‚‹
synchronize: true,
```

```ts:ormconfig.test.ts
module.exports = {
  type: 'mysql',
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || '3306',
  username: process.env.DB_USERNAME || 'root',
  password: process.env.DB_PASSWORD || 'password',
  database: process.env.DB_NAME || 'meetup',
  //  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã™ã‚‹
  synchronize: true,
  // å®Ÿè¡Œã•ã‚Œã‚‹SQLã‚’ãƒ­ã‚°ã¨ã—ã¦åã
  logging: true,
  migrationsRun: true,
  dropSchema: true,
  entities: ['src/entities/*.ts'],
  migrations: ['src/databases/migrations/*.ts'],
  seeds: ['src/databases/seeders/*.seed.{js,ts}'],
  factories: ['src/databases/factories/*.factory.{js,ts}'],
  cli: {
    migrationsDir: 'src/databases/migrations',
    entitiesDir: 'src/entities',
    seedersDir: 'src/databases/seeders',
    factoriesDir: 'src/databases/factories',
  },
};
```

## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…

ä»Šå›ã¯ç™»éŒ²æ©Ÿèƒ½ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã¾ã™

### ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§åˆ©ç”¨ã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```bash
npm i randomstring
npm i typeorm-seeding
```

https://www.npmjs.com/package/randomstring

https://docs.nestjs.com/fundamentals/testing

```ts:test/user.e2e-spec.ts
import { INestApplication, ValidationPipe } from '@nestjs/common';
import { Test, TestingModule } from '@nestjs/testing';
import { TypeOrmModule } from '@nestjs/typeorm';
import { User } from '../src/entities/user.entity';
import { ConfigModule } from '@nestjs/config';
import { AppModule } from '../src/modules/app.module';
import { UsersController } from '../src/controllers/users.controller';
import { CreateUserDto } from '../src/dto/create-user.dto';
import * as request from 'supertest';
import * as randomstring from 'randomstring';
import { UsersService } from '../src/services/users.service';
import { useRefreshDatabase } from 'typeorm-seeding';

describe('UserController(E2E)', () => {
  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šæº–å‚™ã—ã¾ã™
  let app: INestApplication;

  // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ¯å›å®Ÿè¡Œ
  beforeEach(async () => {
    // DBã«æ¥ç¶šï¼†å†…éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    await useRefreshDatabase();
  });

  // ãƒ†ã‚¹ãƒˆå‰ã«1å›ã ã‘å®Ÿè¡Œ
  beforeAll(async () => {
    const moduleFixure: TestingModule = await Test.createTestingModule({
      imports: [
        // Entityã‚’DIã™ã‚‹
        TypeOrmModule.forFeature([User]),

        // ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®TypeORMè¨­å®šã‚’èª­ã¿è¾¼ã‚€
        ConfigModule.forRoot({ envFilePath: 'ormconfig.test.ts' }),

        AppModule,
      ],

      controllers: [UsersController],
      providers: [UsersService],
    }).compile();

    // å®Ÿè¡Œç’°å¢ƒã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
    app = moduleFixure.createNestApplication();

    // ValidationPipeæœ‰åŠ¹åŒ–
    app.useGlobalPipes(new ValidationPipe());

    // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–
    await app.init();
  });

  // ãƒ†ã‚¹ãƒˆå¾Œã«1å›ã ã‘å®Ÿè¡Œ
  afterAll(async () => {
    // ãƒ†ã‚¹ãƒˆçµ‚äº†
    await app.close();
  });

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ†ã‚¹ãƒˆ', () => {
    // API ã®å®Ÿè¡Œã«æˆåŠŸã™ã‚‹
    it('OK /users (POST)', async () => {
      const body: CreateUserDto = {
        name: 'Test',
        email: 'hogeTest@example.com',
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(201);
    });

    it('NG /users é‡è¤‡åˆ¤å®š (POST)', async () => {
      const body: CreateUserDto = {
        name: 'Test',
        email: 'hogeTest@example.com',
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);

      const DuplicateBody: CreateUserDto = {
        name: 'Test',
        email: 'hogeTest@example.com',
        password: 'Password1234',
      };

      const ErrorRes = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);

      expect(ErrorRes.status).toEqual(400);
    });

    it('NG /users name255æ–‡å­—ä»¥ä¸Š(POST)', async () => {
      const body: CreateUserDto = {
        name: randomstring.generate(256),
        email: 'hogeTest@example.com',
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users nameNull(POST)', async () => {
      const body: CreateUserDto = {
        name: null,
        email: 'hogeTest@example.com',
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users email256æ–‡å­—(POST)', async () => {
      const body: CreateUserDto = {
        name: 'test',
        email: `${randomstring.generate(256)}@example.com`,
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users emailå½¢å¼ã‚¨ãƒ©ãƒ¼(POST)', async () => {
      const body: CreateUserDto = {
        name: 'test',
        email: `${randomstring.generate(10)}`,
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users emailNull(POST)', async () => {
      const body: CreateUserDto = {
        name: 'test',
        email: null,
        password: 'Password1234',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users passwordNull(POST)', async () => {
      const body: CreateUserDto = {
        name: 'test',
        email: 'hogeTest@example.com',
        password: null,
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });

    it('NG /users passwordå½¢å¼ã‚¨ãƒ©ãƒ¼(POST)', async () => {
      const body: CreateUserDto = {
        name: 'test',
        email: 'hogeTest@example.com',
        password: 'pass',
      };

      const res = await request(app.getHttpServer())
        .post('/users')
        .set('Accept', 'application/json')
        .send(body);
      expect(res.status).toEqual(400);
    });
  });
});
```

## E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’æ›´æ–°

https://qiita.com/naoki-haba/items/4c47c1972fa2bc988182

https://jestjs.io/ja/docs/cli

```bash
# ç¾åœ¨ã®ãƒ—ãƒ­ã‚»ã‚¹ã§å…¨ã¦ã®ãƒ†ã‚¹ãƒˆã‚’1ã¤ãšã¤å®Ÿè¡Œ
--runInBand

# å…¨ãƒ†ã‚¹ãƒˆãŒçµ‚äº†ã—ãŸå¾Œã«Jestã‚’å¼·åˆ¶çš„ã«çµ‚äº†
--forceExit 

# Jest ãŒä½•ã‚‚å‡ºåŠ›ã›ãšã«çµ‚äº†ã™ã‚‹ã®ã‚’é˜²ã
--detectOpenHandles

# ãƒ†ã‚¹ãƒˆã®æ¢ç´¢ã¨å®Ÿè¡Œã®æ–¹æ³•ã‚’æŒ‡å®šã™ã‚‹ Jest ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å¼•æ•°ã«æŒ‡å®š
--config
```

```diff_json:package.json
{
  "name": "meet-up-dev",
  "version": "0.0.1",
  "description": "",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
+    "test:e2e": "jest --runInBand --forceExit --detectOpenHandles --config ./test/jest-e2e.json"
  },
```

### E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

```bash
npm run test:e2e 

Test Suites: 1 passed, 1 total
Tests:       9 passed, 9 total
Snapshots:   0 total
Time:        8.53 s
Ran all test suites.
```

# `GitHubActions`ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã™ã‚‹

https://github.co.jp/features/actions

https://qiita.com/HeRo/items/935d5e268208d411ab5a

## ãƒ†ã‚¹ãƒˆç”¨DockerFileã‚’å®šç¾©

```dockerfile:DockerfileTest
# FROM ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã™ã‚‹
# as build-stage ãƒ“ãƒ«ãƒ‰ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨å®Ÿè¡Œç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ†ã‘ã‚‹
# -alpine è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM node:14.16.1-alpine as build-stage

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /work

COPY . /work/

RUN npm install

# ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
CMD ["npm","run","test:e2e"]
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã®MySQLã‚³ãƒ³ãƒ†ãƒŠã‚’æ§‹ç¯‰

```yml:unit-test.yml
# docker-composeã§ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
version: '3'

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ãŸã‚ã®å„è¦ç´ 
services:
  # ã‚³ãƒ³ãƒ†ãƒŠå
  app:
    # ComposeFileã‚’å®Ÿè¡Œã—ã€ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ã¨ãã®path
    build:
      # docker buildã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´æ‰€
      context: "."
      # Dockerfileã®ã‚ã‚‹å ´æ‰€
      dockerfile: "DockerfileTest"
    # ã‚³ãƒ³ãƒ†ãƒŠå
    container_name: github-actions-api-test
    # ãƒãƒ¼ãƒˆç•ªå·
    ports:
      - '3000:3000'
      # ç’°å¢ƒå¤‰æ•°
    environment:
      PORT: 3000
      TZ: 'Asia/Tokyo'
      DB_HOST: 'testdb'
      DB_PORT: '3306'
      DB_USERNAME: 'root'
      DB_PASSWORD: 'password'
      DB_NAME: 'meetup'
      # ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚
    depends_on:
      - testdb

  testdb:
    image: mysql:8.0
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    container_name: db_container_e2e_test
    ports:
      - 3306:3306
    environment:
      TZ: 'Asia/Tokyo'
      MYSQL_ROOT_PASSWORD: password
      MYSQL_DATABASE: meetup
      MYSQL_USER: app
      MYSQL_PASSWORD: secret
```

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©

```yml:run_test.yml
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹GitHubã‚¤ãƒ™ãƒ³ãƒˆã®åå‰
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨å®Ÿè¡Œã™ã‚‹
  push:
    branches:
      - main
# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  run-test:
    name: Run Test
    # ubuntuç’°å¢ƒã§å‹•ä½œ
    runs-on: ubuntu-latest
    # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©
    steps:
      - name: checkout pushed commit
        # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v2
        with:
          # PRã®HEADãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ã†
          ref: ${{ github.event.pull_request.head.sha }}
      # E2E ãƒ†ã‚¹ãƒˆã‚’ Docker Compose ã§å®Ÿè¡Œã™ã‚‹
      - name: run test on docker-compose
        run: |
          docker-compose -f ./unit-test.yml build
          docker-compose -f ./unit-test.yml up --abort-on-container-exit
        working-directory: ./
```


## mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹

å®šç¾©ã—ãŸE2Eãƒ†ã‚¹ãƒˆã‚’è¡Œã†ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-03-27 21.52.34.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/d000ce0e-1466-dafa-ec7e-3ad02c70887d.png)
