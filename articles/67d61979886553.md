---
title: "docker-compose + GithubActionsã§CIãƒ»CDç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics:
  - "docker"
  - "githubactions"
  - "cicd"
  - "e2e"
  - "typeorm"
published: true
published_at: "2021-11-28 19:59"
---

# æ¦‚è¦

ã“ã¡ã‚‰ã§ä½œæˆã—ãŸE2Eãƒ†ã‚¹ãƒˆã‚’`docker-compose up`ã§å®Ÿè¡Œã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã—ãŸ
https://zenn.dev/naonao70/articles/5167d8c18c81e2


# ã‚„ã‚Šæ–¹

## e2eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹Dockerfileã‚’ä½œæˆã—ã¾ã™

```docker:Dockerfile.test
# FROM ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æŒ‡å®šã™ã‚‹
# as build-stage ãƒ“ãƒ«ãƒ‰ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã¨å®Ÿè¡Œç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ†ã‘ã‚‹
# -alpine è»½é‡ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM node:14.16.1-alpine as build-stage

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
WORKDIR /work

COPY . /work/

RUN npm install

# ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹
CMD ["npm","run","test:e2e"]
```

## é–‹ç™ºç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹Dockerfileã‚’ä½œæˆã—ã¾ã™
```docker:Dockerfile.migrate
FROM node:14.16.1-alpine

WORKDIR /work

COPY ./src/databases /work/src/databases
COPY ./package.json ./package-lock.json ./ormconfig.ts ./tsconfig.json /work/

RUN npm install

CMD ["npm", "run", "typeorm", "migration:run"]
```

## E2Eãƒ†ã‚¹ãƒˆç”¨ã®ymlãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

```yml:unit-test.yml
# docker-composeã§ä½¿ç”¨ã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³
version: '3'

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã™ãŸã‚ã®å„è¦ç´ 
services:
  # ã‚³ãƒ³ãƒ†ãƒŠå
  app:
    # ComposeFileã‚’å®Ÿè¡Œã—ã€ãƒ“ãƒ«ãƒ‰ã•ã‚Œã‚‹ã¨ãã®path
    build:
      # docker buildã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸå ´æ‰€
      context: "."
      # Dockerfileã®ã‚ã‚‹å ´æ‰€
      dockerfile: "Dockerfile.test"
      # image ID
    image: hoge-test
    # ã‚³ãƒ³ãƒ†ãƒŠå
    container_name: hoge-test
    # ãƒãƒ¼ãƒˆç•ªå·
    ports:
      - '3000:3000'
      # ç’°å¢ƒå¤‰æ•°
    environment:
      PORT: xxx
      TZ: 'Asia/Tokyo'
      DB_HOST: 'xx'
      DB_PORT: 'xxxx'
      DB_USERNAME: 'xxxx'
      DB_PASSWORD: 'xxxx'
      DB_NAME: 'hoge'
      REDIS_HOST: 'xx'
      REDIS_PORT: 'xx'
      # ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ä¾å­˜é–¢ä¿‚
    depends_on:
      - db
      - redis

  redis:
    image: redis:5.0
    container_name: redis_container-test
    ports:
      - "xxxx:xxxx"

  db:
    image: mysql:8.0
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    container_name: db_container_test
    ports:
      - xxxx:xxxx
    environment:
      TZ: 'Asia/Tokyo'
      MYSQL_ROOT_PASSWORD: xxxx
      MYSQL_DATABASE: xxxx
      MYSQL_USER: xxxx
      MYSQL_PASSWORD: xxxx
```

## TypeOrmç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

:::message alert
ä»¥ä¸‹ã®è¨­å®šã‚’æœ¬ç•ªç’°å¢ƒã§ã™ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å¿…ãšè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯æœ¬ç•ªç”¨ãƒ»ãƒ†ã‚¹ãƒˆç”¨ã§åˆ†ã‘ã¦ãã ã•ã„ï¼
:::

> typeormãŒæŒã¤synchronizeã®æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã€ãƒ’ãƒˆãŒãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã›ãšã¨ã‚‚ã‚¹ã‚­ãƒ¼ãƒã•ãˆã‚ã‚Œã°ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã€‚
åŒæœŸ-ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’è‡ªå‹•ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒãƒƒã‚°ãŠã‚ˆã³é–‹ç™ºä¸­ã«å½¹ç«‹ã¡ã¾ã™ã€‚ãã®ä»£ã‚ã‚Šã«ã€CLIã‚’ä½¿ç”¨ã—ã¦schemaï¼šsyncã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚

```ts:ormconfig.test.ts
module.exports = {
  type: 'mysql',
  host: process.env.DB_HOST || 'localhost',
  port: process.env.DB_PORT || 'xxxx',
  username: process.env.DB_USERNAME || 'xxxx',
  password: process.env.DB_PASSWORD || 'xxxx',
  database: process.env.DB_NAME || 'xxxx',
  //  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã™ã‚‹
  synchronize: true,
  // å®Ÿè¡Œã•ã‚Œã‚‹SQLã‚’ãƒ­ã‚°ã¨ã—ã¦åã
  logging: true,
  entities: ['src/domain/entities/*.ts'],
  migrations: ['src/databases/migrations/*.ts'],
  seeds: ['src/test/databases/seeders/*.seed.{js,ts}'],
  subscribers: ['src/subscribers/**/*.ts'],
  cli: {
    migrationsDir: 'src/databases/migrations',
    entitiesDir: 'src/domain/entities',
    seedersDir: 'src/databases/seeders',
    subscribersDir: 'src/subscribers',
  },
}
```

## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹

```bash:bash
# E2Eãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’
docker-compose -f unit-test.yml build

# E2Eãƒ†ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• ãƒ†ã‚¹ãƒˆçµ‚ã‚ã£ãŸã‚‰ã‚³ãƒ³ãƒ†ãƒŠè½ã¨ã™
docker-compose -f unit-test.yml up  --abort-on-container-exit
Recreating redis_container ... done
Recreating db_container    ... done
Recreating xxx-api-test ... done
Attaching to redis_container-test, db_container_test, xxx-api-test

xxx-api-test |
xxx-api-test | > sample@0.0.1 test:e2e /work
xxx-api-test | > jest --config ./src/test/e2e/jest-e2e.json
xxx-api-test |
xxx-api-test | PASS src/test/e2e/contractor-reps.e2e-spec.ts (92.288 s)
xxx-api-test   å¥‘ç´„æ‹…å½“è€…(E2E)
xxx-api-test     ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯401ãŒè¿”ã‚Šã¾ã™
xxx-api-test       âœ“ OK /contractor-reps (GET) (1471 ms)
xxx-api-test     å¥‘ç´„æ‹…å½“è€…ä¸€è¦§ãƒ†ã‚¹ãƒˆ_ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†
xxx-api-test       âœ“ OK /contractor-reps (GET) (1195 ms)
// çœç•¥

xxx-api-test Test Suites: 1 passed, 1 total
xxx-api-test Tests:       38 passed, 38 total
xxx-api-test Snapshots:   0 total
xxx-api-test Time:        92.428 s
xxx-api-test Ran all test suites.
xxxx-api-test exited with code 0
```

## GitHubActionsã‚’è¨­å®šã™ã‚‹

```
# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹GitHubã‚¤ãƒ™ãƒ³ãƒˆã®åå‰
on:
# PRä½œæˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹
  pull_request:
  # PRä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«å®Ÿè¡Œ
    types: [opened, synchronize]
# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  run-test:
    name: Run Test
    # ubuntuç’°å¢ƒã§å‹•ä½œ
    runs-on: ubuntu-latest
    # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©
    steps:
    - name: checkout pushed commit
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v2
      with:
      # PRã®HEADãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ã†
        ref: ${{ github.event.pull_request.head.sha }}
    # E2E ãƒ†ã‚¹ãƒˆã‚’ Docker Compose ã§å®Ÿè¡Œã™ã‚‹
    - name: run test on docker-compose
      run: |
        docker-compose -f ./unit-test.yml build
        docker-compose -f ./unit-test.yml up --abort-on-container-exit
      working-directory: ./
```


# æœ€å¾Œã«

èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»Šå›ã®è¨˜äº‹ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
ãƒ»ã“ã†ã„ã†è¨˜äº‹ãŒèª­ã¿ãŸã„
ãƒ»ã“ã†ã„ã†ã¨ã“ã‚ãŒè‰¯ã‹ã£ãŸ
ãƒ»ã“ã†ã—ãŸæ–¹ãŒè‰¯ã„ã®ã§ã¯ãªã„ã‹
ãªã©ãªã©ã€ç‡ç›´ãªã”æ„è¦‹ã‚’å‹Ÿé›†ã—ã¦ãŠã‚Šã¾ã™ã€‚