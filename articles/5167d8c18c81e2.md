---
title: "Jest + Nest.jsã§å§‹ã‚ã‚‹!  E2Eãƒ†ã‚¹ãƒˆ"
emoji: "ğŸˆ"
type: "tech"
topics:
  - "githubactions"
  - "jest"
  - "nestjs"
  - "cicd"
  - "typeorm"
published: true
published_at: "2021-11-28 04:37"
---

# æ¦‚è¦

`NestJs`ã§`Jest`ã«ã‚ˆã‚‹`E2E`ãƒ†ã‚¹ãƒˆã‚’å°å…¥ã—ãŸã®ã§çŸ¥è¦‹ã‚’ã¾ã¨ã‚ã‚‹

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```bash
e2e
â”‚   â”œâ”€â”€ users.e2e-spec.ts
â”‚   â”œâ”€â”€ jest-e2e.json
â”‚   â”œâ”€â”€ mocks
â”‚   â”‚   â””â”€â”€ contractorReps
â”‚   â”‚       â””â”€â”€ mock.ts
â”‚   â””â”€â”€ utilities
â”‚       â”œâ”€â”€ common.utility.ts
â”‚       â””â”€â”€ master.utility.ts
```

## è¨­å®šç”¨ã®jsonãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

- `moduleFileExtensions`:ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒä½¿ç”¨ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã®é…åˆ—
- `rootDir`:Jestã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
- `testEnvironment`:ãƒ†ã‚¹ãƒˆç’°å¢ƒ
- `testRegex`:JestãŒãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã™ã‚‹éš›ã«ä½¿ç”¨ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
- `transform`:ãƒ‘ã‚¹ã€ãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚©ãƒ¼ãƒãƒ¼ã¸ã®ãƒãƒƒãƒ—
- `moduleNameMapper`:è©¦é¨“å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹

```json:/e2e/jest-e2e.json
{
    "moduleFileExtensions": [
        "js",
        "json",
        "ts"
    ],
    "rootDir": ".",
    "testEnvironment": "node",
    "testRegex": ".e2e-spec.ts$",
    "transform": {
        "^.+\\.(t|j)s$": "ts-jest"
    },
    
    "moduleNameMapper": {
        "^src/(.*)$": "<rootDir>/../../$1"
    }
}
```

https://jestjs.io/ja/docs/configuration#modulenamemapper-objectstring-string--arraystring

## TypeORMç”¨ã®ãƒ†ã‚¹ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ

:::message alert
TypeORMã«ã¯migrationã‚’è‡ªå‹•çš„ã«è¡Œã†æ©Ÿèƒ½ãŒå­˜åœ¨ã—ãªã„ã®ã§ã€`synchronize: true`ã¨ã—å¼·åˆ¶çš„ã«migrationã‚’å®Ÿè¡Œã•ã›ã¦ã„ã¾ã™

æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§å¿…ãšæœ¬ç•ªç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯`synchronize: false`ã¨ã™ã‚‹ã“ã¨
:::

> typeormãŒæŒã¤synchronizeã®æ©Ÿèƒ½ã‚’ä½¿ãˆã°ã€ãƒ’ãƒˆãŒãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã›ãšã¨ã‚‚ã‚¹ã‚­ãƒ¼ãƒã•ãˆã‚ã‚Œã°ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã‚‹ã€‚
åŒæœŸ-ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’è‡ªå‹•ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¤ºã—ã¾ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¯æ³¨æ„ã—ã¦ãã ã•ã„ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚æœ¬ç•ªç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‡ãƒãƒƒã‚°ãŠã‚ˆã³é–‹ç™ºä¸­ã«å½¹ç«‹ã¡ã¾ã™ã€‚

https://github.com/typeorm/typeorm/blob/master/docs/faq.md

```ts:ormconfig.test.ts
module.exports = {
  type: 'mysql',
  host: process.env.DB_HOST || 'xxxx',
  port: process.env.DB_PORT || 'xxxx',
  username: process.env.DB_USERNAME || 'xxxx',
  password: process.env.DB_PASSWORD || 'xxxx',
  database: process.env.DB_NAME || 'xxxx',
  //  ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«Entityã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åŒæœŸã™ã‚‹
  synchronize: true,
  // å®Ÿè¡Œã•ã‚Œã‚‹SQLã‚’ãƒ­ã‚°ã¨ã—ã¦åã
  logging: true,
  entities: ['src/domain/entities/*.ts'],
  migrations: ['src/databases/migrations/*.ts'],
  seeds: ['src/test/databases/seeders/*.seed.{js,ts}'],
  subscribers: ['src/subscribers/**/*.ts'],
  cli: {
    migrationsDir: 'src/databases/migrations',
    entitiesDir: 'src/domain/entities',
    seedersDir: 'src/databases/seeders',
    subscribersDir: 'src/subscribers',
  },
}
```

## ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash:bash
npm i --save-dev @nestjs/testing
```

https://docs.nestjs.com/fundamentals/testing

## ãƒ†ã‚¹ãƒˆã™ã‚‹APIã«ã¤ã„ã¦

ä»¥ä¸‹ã®å½¢å¼ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¿”ã™APIã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã¾ã™

#### ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
`http://localhost:xxxx/users?name=ãƒ†ã‚¹ãƒˆ`

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿

```json
{
    "statusCode": 200,
    "message": "SUCCESS",
    "data": [
        {
            "id": 1,
            "name": "ãƒ†ã‚¹ãƒˆ",
            "ins_ts": "2021/11/29 13:47"
        }
}
```


## ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã¯å‰²æ„›ã—ã¦ã„ã¾ã™

```ts:users.e2e-spec.ts
import { INestApplication, ValidationPipe } from '@nestjs/common'
import { ConfigModule } from '@nestjs/config'
import { APP_GUARD } from '@nestjs/core'
import { Test, TestingModule } from '@nestjs/testing'
import { TypeOrmModule } from '@nestjs/typeorm'
import * as request from 'supertest'

describe('ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ(E2E)', () => {
  // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­å®šé–‹å§‹
  let app: INestApplication

  // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚ã«æ¯å›å®Ÿè¡Œã—ã¾ã™
  beforeEach(async () => {
    // DBã«æ¥ç¶šï¼†å†…éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    await useRefreshDatabase()

    // ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ‰ã™ã‚‹
    await runTestDataSeeder()
  })

  // ãƒ†ã‚¹ãƒˆå‰ã«1å›ã ã‘å®Ÿè¡Œã—ã¾ã™
  beforeAll(async () => {
    // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§DIã—ã¦ã„ã‚‹å¯¾è±¡ã‚’å®šç¾©ã—ã¾ã™
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forFeature([User),

        // ãƒ†ã‚¹ãƒˆç”¨ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        ConfigModule.forRoot({
          envFilePath: ENV_FILE_PATH,
        }),

        // ãƒ¡ã‚¤ãƒ³ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        AppModule,
      ],

      controllers: [UserController],

      // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™Guardã‚’ã‚»ãƒƒãƒˆã—ã¾ã™
      providers: [
        ContractorService,
        {
          provide: APP_GUARD,
          useExisting: RoleGuard,
        },
        RoleGuard,
      ],
    }).compile()

    // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™
    app = moduleFixture.createNestApplication()

    // Auto-validation#
    app.useGlobalPipes(new ValidationPipe())

    // ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–
    await app.init()
  })

  // ãƒ†ã‚¹ãƒˆå¾Œã«1å›ã ã‘å®Ÿè¡Œã—ã¾ã™
  afterAll(async () => {
    // ãƒ†ã‚¹ãƒˆçµ‚äº†
    await app.close()

    // DBã¨ã®æ¥ç¶šã‚’çµ‚äº†ã™ã‚‹
    await tearDownDatabase()
  })

  /**
   * @summary ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™
   * @param account
   * @returns request.Response
   */
  const index = async (account?: E2eLoginData): Promise<request.Response> => {
    const res = account
      ? await request(app.getHttpServer())
          .get(API_END_POINTS.USER)
          .set(
            'Authorization',
            `Bearer ${await getJwtToken(request, app, account)}`
          )
      : await request(app.getHttpServer()).get(API_END_POINTS.USER)

    return res
  }

  /**
   * @summary ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã—ã¾ã™
   * @param account
   * @param id
   * @returns request.Response
   */
  const show = async (
    id: number,
    account?: E2eLoginData
  ): Promise<request.Response> => {
    const res = account
      ? await request(app.getHttpServer())
          .get(`${API_END_POINTS.USER}/${id}`)
          .set(
            'Authorization',
            `Bearer ${await getJwtToken(request, app, account)}`
          )
      : await request(app.getHttpServer()).get(
          `${API_END_POINTS.USER}/${id }`
        )

    return res
  }

  /**
   * @summary ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã™
   * @param account
   * @param body
   * @returns request.Response
   */
  const create = async (
    dto: CreateUserDto,
    account?: E2eLoginData
  ): Promise<request.Response> => {
    const res = account
      ? await request(app.getHttpServer())
          .post(API_END_POINTS.USER)
          .set(
            'Authorization',
            `Bearer ${await getJwtToken(request, app, account)}`
          )
          .set('Accept', 'application/json') // responseãƒ‡ãƒ¼ã‚¿ã‚’jsonã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„
          .send(dto)
      : await request(app.getHttpServer())
          .post(API_END_POINTS.USER)
          .set('Accept', 'application/json')
          .send(dto)

    return res
  }

  /**
   * @summary ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ã—ã¾ã™
   * @param account
   * @param  id: number,
   * @param body
   * @returns request.Response
   */
  const update = async (
    dto: UpdateUserDto,
    id: number,
    account?: E2eLoginData
  ): Promise<request.Response> => {
    const res = account
      ? await request(app.getHttpServer())
          .patch(`${API_END_POINTS.USER}/${id}`)
          .set(
            'Authorization',
            `Bearer ${await getJwtToken(request, app, account)}`
          )
          .set('Accept', 'application/json') // responseãƒ‡ãƒ¼ã‚¿ã‚’jsonã¨ã—ã¦æ‰±ã£ã¦ãã ã•ã„
          .send(dto)
      : await request(app.getHttpServer())
          .patch(`${API_END_POINTS.USER}/${id}`)
          .set('Accept', 'application/json')
          .send(dto)

    return res
  }

  /**
   * @summary ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è«–ç†å‰Šé™¤ã—ã¾ã™
   * @param account
   * @param  id: number,
   * @param body
   * @returns request.Response
   */
  const softDelete = async (
    id: number,
    account?: E2eLoginData
  ): Promise<request.Response> => {
    const res = account
      ? await request(app.getHttpServer())
          .delete(`${API_END_POINTS.USER}/${id}`)
          .set(
            'Authorization',
            `Bearer ${await getJwtToken(request, app, account)}`
          )
      : await request(app.getHttpServer()).delete(
          `${API_END_POINTS.USER}/${id}`
        )

    return res
  }

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ã‚¹ãƒˆ', () => {
    it('OK /users(GET)', async () => {
      const res = await index(LOGIN_DATA.SERVICE_ADMIN)
      expect(res.status).toEqual(HTTP_STATUS_CODES.OK)
      expect(res.body).toEqual(INDEX_USERS)
    })
  })

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ†ã‚¹ãƒˆ', () => {
    it('OK /users/:id (GET)', async () => {
      const id = (await index(LOGIN_DATA.SERVICE_ADMIN)).body[0]
        .id

      const res = await show(id, LOGIN_DATA.SERVICE_ADMIN)
      expect(res.status).toEqual(HTTP_STATUS_CODES.OK)
      expect(res.body).toEqual(SHOW_USER_DATA)
    })
  })

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ†ã‚¹ãƒˆ', () => {
    it('OK /users (POST)', async () => {
      const body: CreateUserDto = {
        name: 'hoge',
        password: 'password',
        password_confirm: 'password',
      }

      const res = await create(body, LOGIN_DATA.SERVICE_ADMIN)
      expect(res.status).toEqual(HTTP_STATUS_CODES.CREATED)
      expect(res.body.message).toEqual(RESPONSE_MESSAGES.USER)
    })
  })

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒ†ã‚¹ãƒˆ', () => {
    it('OK users/:id (PATCH)', async () => {
      const id = (await index(LOGIN_DATA.SERVICE_ADMIN)).body[0]
        .id

      const body: UpdateUserDto = {
        name: 'fuga',
        password: 'password',
        password_confirm: 'password',
      }

      const res = await update(
        body,
        id,
        LOGIN_DATA.SERVICE_ADMIN
      )
      expect(res.status).toEqual(HTTP_STATUS_CODES.OK)
      expect(res.body.message).toEqual(
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${id}ã€ã®æ›´æ–°ã«æˆåŠŸã—ã¾ã—ãŸã€‚`
      )
    })
  })

  describe('ãƒ¦ãƒ¼ã‚¶ãƒ¼è«–ç†å‰Šé™¤ãƒ†ã‚¹ãƒˆ', () => {
    it('OK /users/:id (DELETE)', async () => {
      const id = (await index(LOGIN_DATA.SERVICE_ADMIN)).body[0]
        .id

      const res = await softDelete(contractor_rep_id, LOGIN_DATA.SERVICE_ADMIN)
      expect(res.status).toEqual(HTTP_STATUS_CODES.OK)
      expect(res.body.message).toEqual(
        `ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã€Œ${contractor_rep_id}ã€ã®è«–ç†å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚`
      )
    })
  })
```

## ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ

```bash:bash
# 2. E2E ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
npm run test:e2e

# æˆåŠŸ
PASS  src/test/e2e/user.e2e-spec.ts (33.623 s)
  ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ(E2E)
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ†ã‚¹ãƒˆ
      âœ“ OK /users(GET) (1748 ms)
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†ãƒ†ã‚¹ãƒˆ
      âœ“ OK /users/:id (GET) (1735 ms)
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ†ã‚¹ãƒˆ
      âœ“ OK /users (POST) (1493 ms)
    ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°ãƒ†ã‚¹ãƒˆ
      âœ“ OK users/:id (PATCH) (1327 ms)
    ãƒ¦ãƒ¼ã‚¶ãƒ¼è«–ç†å‰Šé™¤ãƒ†ã‚¹ãƒˆ
      âœ“ OK /users/:id (DELETE) (1557 ms)
```

# E2Eãƒ†ã‚¹ãƒˆã‚’GitHub Actionsã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ

https://zenn.dev/naonao70/articles/67d61979886553

# æœ€å¾Œã«
èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»Šå›ã®è¨˜äº‹ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
ãƒ»ã“ã†ã„ã†è¨˜äº‹ãŒèª­ã¿ãŸã„
ãƒ»ã“ã†ã„ã†ã¨ã“ã‚ãŒè‰¯ã‹ã£ãŸ
ãƒ»ã“ã†ã—ãŸæ–¹ãŒè‰¯ã„ã®ã§ã¯ãªã„ã‹
ãªã©ãªã©ã€ç‡ç›´ãªã”æ„è¦‹ã‚’å‹Ÿé›†ã—ã¦ãŠã‚Šã¾ã™ã€‚
