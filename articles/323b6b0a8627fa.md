---
title: "PHPã‚¹ã‚¯ãƒªãƒ—ãƒˆã§SSLè¨¼æ˜æ›¸æœŸé™ã‚’ç›£è¦–ã—ã¦ã¿ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics:
  - "php"
  - "domain"
  - "ssl"
  - "openssl"
published: true
published_at: "2021-12-05 01:29"
---

# æ¦‚è¦
ãƒ‰ãƒ¡ã‚¤ãƒ³ã®SSLè¨¼æ˜æ›¸æœŸé™ã‚’`openssl`ã§ãƒã‚§ãƒƒã‚¯ã—ã¦ç›£è¦–ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã£ãŸæ™‚ã®å‚™å¿˜éŒ²


# ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```php:ssl_watch.php
<?php

$domain_names = [
    'google.com',
    'yahoo.jp'
];

# ChatWorkã®é€šçŸ¥ã™ã‚‹ãƒ«ãƒ¼ãƒ ID
define('DEFAULT_ROOM_ID', 'xxxx');

# ChatWorkã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆãƒ¼ã‚¯ãƒ³
define('DEFAULT_USER_TOKEN', 'xxxx');
$warning_messages = [];
$nossl_messages = [];
foreach ($domain_names as $domain_name) {
    */
    /**===================================
     * * shell_exec()ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™
     * * openssl s_client xxx ä»¥é™ã§SSLæƒ…å ±ã‚’å–å¾—
     * * notAfter = è¨¼æ˜æ›¸æœŸé™ãªã®ã§æŠœãå‡ºã™
     * * GMT ã‚°ãƒªãƒ‹ãƒƒã‚¸æ¨™æº–æ™‚ã«ãªã£ã¦ã„ã‚‹ã®ã§DateTimeã§
     * * æ—¥æœ¬ã®æ—¥ä»˜ã«å¤‰æ›ã—ã¾ã™
     *====================================**/
    unset($_warning_message);
    unset($_nossl_message);
 
    $response = shell_exec("(timeout 1 openssl s_client -servername {$domain_name} -connect {$domain_name}:443 2>/dev/null | openssl x509 -noout -enddate | grep notAfter | sed -e s#notAfter=##)");
    $expire_date = $response ? (new DateTime($response, new DateTimeZone('ASIA/TOKYO')))->format('Y-m-d') : null;
    if (!$expire_date) $_nossl_message = "ã€SSLè¨¼æ˜æ›¸æœŸé™ã€‘{$domain_name} (æœŸé™åˆ‡ã‚Œã‚‚ã—ãã¯å–å¾—å¤±æ•—)";
    if (IS_TEST || strtotime($expire_date) < mktime(0, 0, 0, date('m') + 1, date('d'), date('Y'))) $_warning_message = "ã€SSLè¨¼æ˜æ›¸æœŸé™ã€‘{$domain_name} ({$expire_date})";
    if (!empty($_warning_message)) {
        if (IS_TEST) $_warning_message = 'TEST ' . $_warning_message;
        $warning_messages[] = $_warning_message;
        echo $_warning_message . "\n";
    }
    if (!empty($_nossl_message)) {
        if (IS_TEST) $nossl_messages = 'TEST ' . $_nossl_message;
        $nossl_messages[] = $_nossl_message;
        echo $_nossl_message . "\n";
    }
}
//if(!empty($warning_messages)) SendSlack::send(implode("\n", $warning_messages));
if (!empty($warning_messages)) SendSlack::exec_notice("[toall]" . implode("\n", $warning_messages), 'æœŸé™ãŒ1ãƒ¶æœˆå‰ã®SSLä¸€è¦§é€šçŸ¥');
if (!empty($nossl_messages)) SendSlack::exec_notice("[toall]" . implode("\n", $nossl_messages), 'æœŸé™åˆ‡ã‚Œã‚‚ã—ãã¯HTTPSã˜ã‚ƒç„¡ã„SSLä¸€è¦§é€šçŸ¥');
return;

class SendMessage {
    
    //ãƒãƒ£ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é€šçŸ¥
    public static function exec_notice($message, $title = null, $room_id = null, $user_token = null) {
        if (!$room_id) {
            $room_id = DEFAULT_ROOM_ID;
        }
        if (!$user_token) {
            $user_token = DEFAULT_USER_TOKEN;
        }
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        $curl = null;
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ 2ç§’
        $timeout_sec = 2;
        // ãƒ«ãƒ¼ãƒ IDã‚’æŒ‡å®šã—ã¦CURLåˆæœŸåŒ–
        $curl = curl_init('https://api.chatwork.com/v2/rooms/' . $room_id . '/messages');
        // ãƒ¦ãƒ¼ã‚¶ãƒˆãƒ¼ã‚¯ãƒ³
        $headers = array('X-ChatWorkToken: ' . $user_token);
        // é€šçŸ¥å†…å®¹
        $body = '';
        if (is_null($title)) {
            $body = $message;
        } else {
            $body = '[info][title]';
            $body .= $title;
            $body .= '[/title]';
            $body .= $message;
            $body .= '[/info]';
        }
        $fields = ['body' => $body];
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®š
        curl_setopt($curl, CURLOPT_CUSTOMREQUEST, 'POST');
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_POSTFIELDS, http_build_query($fields));
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        // é€šçŸ¥å®Ÿè¡Œ
        $ret = curl_exec($curl);
        // å‡¦ç†çµæœ
        if ($ret === false) {
            return false;
        }
        return (strpos($ret, 'message_id') !== false);
    }
}
```

# æœ€å¾Œã«

èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»Šå›ã®è¨˜äº‹ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
ãƒ»ã“ã†ã„ã†è¨˜äº‹ãŒèª­ã¿ãŸã„
ãƒ»ã“ã†ã„ã†ã¨ã“ã‚ãŒè‰¯ã‹ã£ãŸ
ãƒ»ã“ã†ã—ãŸæ–¹ãŒè‰¯ã„ã®ã§ã¯ãªã„ã‹
ãªã©ãªã©ã€ç‡ç›´ãªã”æ„è¦‹ã‚’å‹Ÿé›†ã—ã¦ãŠã‚Šã¾ã™ã€‚