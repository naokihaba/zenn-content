---
title: "ã€å®Ÿè·µã€‘Laravel+MySQLã®å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½"
emoji: "ğŸ¥"
type: "tech"
topics:
  - "docker"
  - "laravel"
  - "mysql"
  - "ngram"
published: true
published_at: "2022-01-02 17:36"
---

# ã¯ã˜ã‚ã«


`LIKE`æ¤œç´¢ã¯å…¨ã¦ã®è¡Œã«å¯¾ã—ã¦æ¡ä»¶ã«åˆè‡´ã™ã‚‹ã‹ã‚’åˆ¤å®šã™ã‚‹ã®ã§ãƒ‡ãƒ¼ã‚¿ãŒå¢—ãˆã‚‹ã«ã¤ã‚Œæ¤œç´¢é€Ÿåº¦ãŒé…ããªã‚‹å ´åˆãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€MySQLã®å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’å°å…¥ã—ãŸæ–¹æ³•ã«ã¤ã„ã¦ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

https://dev.mysql.com/doc/refman/8.0/ja/fulltext-search-ngram.html

å®Œæˆç³»ã®ãƒªãƒã‚¸ãƒˆãƒª
@ucan-labã•ã‚“ã®è¨˜äº‹ã‚’å‚è€ƒã«LAMPç’°å¢ƒã‚’æ§‹ç¯‰ã„ãŸã—ã¾ã—ãŸğŸ™‡â€â™‚ï¸

https://qiita.com/ucan-lab/items/56c9dc3cf2e6762672f4

https://github.com/nao-haba-dev/ngram-docker-laravel

# äº‹å‰æº–å‚™
- GitHubãƒ»DockerãŒåˆ©ç”¨ã§ãã‚‹æº–å‚™ã‚’ãŠé¡˜ã„ã—ã¾ã™

https://github.com

https://qiita.com/ucan-lab/items/aadbedcacbc2ac86a2b3

- MAC

https://docs.docker.com/desktop/mac/install/

- Windows

https://docs.docker.com/desktop/windows/install/


## ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³

```bash
git clone https://github.com/nao-haba-dev/ngram-docker-laravel.git
```

## ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
cd docker-laravel
docker-compose up -d
docker-compose exec app bash
composer install
cp .env.example .env
php artisan key:generate
php artisan storage:link
chmod -R 777 storage bootstrap/cache
```

http://localhost:8080/

ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã§ã™
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-01 22.15.28.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/33e6454c-a23a-d0ee-d719-c36f3fd37688.png)

# ä»Šå›ã®ãƒãƒ³ã‚ºã‚ªãƒ³ã®ã‚´ãƒ¼ãƒ«
- å…¨æ–‡æ¤œç´¢ç”¨ã®DDLã‚’ä½œæˆ
- æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
- å…¨æ–‡æ¤œç´¢ã‚’å®Ÿè·µ

# ã€å®Ÿè·µã€‘Laravel+MySQLã§å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã‚’å°å…¥ã—ã¦ã¿ã‚‹

## bootstrapã®ã‚¹ã‚«ã‚¤ãƒ•ã‚©ãƒ¼ãƒ«ãƒ‰ã‚’ç”Ÿæˆ

https://readouble.com/laravel/8.x/ja/frontend.html?header=%25E3%2582%25A4%25E3%2583%25B3%25E3%2583%2588%25E3%2583%25AD%25E3%2583%2580%25E3%2582%25AF%25E3%2582%25B7%25E3%2583%25A7%25E3%2583%25B3

```bash:root@xxxx:/work#
composer require laravel/ui
php artisan ui bootstrap
npm install
npm run dev
```

## å…¨æ–‡æ¤œç´¢ç”¨ã®Modelã¨migrationã‚’ç”Ÿæˆ
https://readouble.com/laravel/8.x/ja/eloquent.html

```bash:root@xxxx:/work#
php artisan make:model Shop --migration
```

## Modelå®šç¾©

```php:backend/app/Models/Shop.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Shop extends Model
{
    use HasFactory;

    /**
     * ãƒ¢ãƒ‡ãƒ«ã«é–¢é€£ä»˜ã‘ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
     *
     * @var string
     */
    protected $table = 'shops';

    /**
     * è¤‡æ•°ä»£å…¥å¯èƒ½ãªå±æ€§
     *
     * @var array
     */
    protected $fillable = ['name', 'age', 'gender_id'];
}
```

## migrationå®šç¾©

```php:backend/database/migrations/2022_01_01_132402_create_shops_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

class CreateShopsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('shops', function (Blueprint $table) {
            $table->bigIncrements('id')->comment('åº—ID');
            $table->string('name', 255)->comment('å¾“æ¥­å“¡');
            $table->unsignedInteger('age')->comment('å¹´é½¢');
            $table->smallInteger('gender_id')->comment('æ€§åˆ¥');
            $table->timestamp('created_at')->default(DB::raw('CURRENT_TIMESTAMP'));
            $table->timestamp('updated_at')->default(DB::raw('CURRENT_TIMESTAMP on update CURRENT_TIMESTAMP'));
        });
        DB::statement("ALTER TABLE shops ADD free_word TEXT as (concat(IFNULL(age, ''), ' ',IFNULL(name, ''), ' ',(case gender_id when 1 then 'ç”·æ€§' when 2 then 'å¥³æ€§' else '' end), ' ')) STORED");
        DB::statement("ALTER TABLE shops ADD FULLTEXT index ftx_free_word (free_word) with parser ngram");
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('shops');
    }
}

```

### migrationå®šç¾©ã®è£œè¶³

Laravelã®ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ã§SQLæ–‡ã‚’ç›´æ¥å®Ÿè¡Œã—ã¾ã™

https://readouble.com/laravel/8.x/ja/database.html

```php:backend/database/migrations/2022_01_01_132402_create_shops_table.php
DB::statement()
```

`ALTER TABLE shops ADD free_word TEXT`:TEXTå‹ã®ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã€€
`as`:`as`ä»¥é™ã®å€¤ã‚’è¿½åŠ ã—ã¦ç”Ÿæˆã—ã¾ã™

https://dev.mysql.com/doc/refman/8.0/ja/alter-table-generated-columns.html

```php:backend/database/migrations/2022_01_01_132402_create_shops_table.php
"ALTER TABLE shops ADD free_word TEXT as xxx STORED
```

`concat`:è¤‡æ•°ã®æ–‡å­—åˆ—ã‚’é€£çµã—ã¾ã™
`IFNULL`:1ç•ªç›®ã«æŒ‡å®šã—ãŸå¼•æ•°ã®å€¤ãŒ NULL ã ã£ãŸå ´åˆã« 2ç•ªç›®ã®å¼•æ•°ã®å€¤ã‚’è¿”ã—ã¾ã™

```php:backend/database/migrations/2022_01_01_132402_create_shops_table.php
(concat(IFNULL(age,''),' ')
```

`case`:å„ WHEN å¥å†…ã® when_value å¼ã®ã„ãšã‚Œã‹ã«ç­‰ã—ããªã‚‹ã¾ã§ã€ãã‚Œã‚‰ã®å¼ã¨æ¯”è¼ƒã•ã‚Œã¾ã™
`when`:æ¡ä»¶
`then`:æ¡ä»¶ã«ä¸€è‡´ã—ãŸå ´åˆã®syori

```php:backend/database/migrations/2022_01_01_132402_create_shops_table.php
(case gender_id when 1 then 'ç”·æ€§' when 2 then 'å¥³æ€§' else '' end), ' '
```

## migration

```bash:root@27c72a17e24e:/work#
php artisan migrate
Migration table created successfully.
Migrating: 2014_10_12_000000_create_users_table
Migrated:  2014_10_12_000000_create_users_table (60.12ms)
Migrating: 2014_10_12_100000_create_password_resets_table
Migrated:  2014_10_12_100000_create_password_resets_table (42.83ms)
Migrating: 2019_08_19_000000_create_failed_jobs_table
Migrated:  2019_08_19_000000_create_failed_jobs_table (63.83ms)
Migrating: 2019_12_14_000001_create_personal_access_tokens_table
Migrated:  2019_12_14_000001_create_personal_access_tokens_table (84.70ms)
Migrating: 2022_01_01_132402_create_shops_table
Migrated:  2022_01_01_132402_create_shops_table (249.35ms)
```

## seederã‚’å®šç¾©

https://readouble.com/laravel/8.x/ja/seeding.html

```php:backend/database/seeders/DummyShopsSeeder.php
<?php

namespace Database\Seeders;

use App\Models\Shop;
use Illuminate\Database\Seeder;

class DummyShopsSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * @return void
     */
    public function run()
    {
        $data = [
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ',
                'age' => 25,
                'gender_id' => 1
            ],
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«èŠ±å­',
                'age' => 30,
                'gender_id' => 2
            ],
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ',
                'age' => 20,
                'gender_id' => 1
            ],
        ];

        (new Shop())->query()->insert($data);
    }
}
```

## Seeding
```bash:root@27c72a17e24e:/work#
php artisan db:seed --class=DummyShopsSeeder
Database seeding completed successfully.
```

## Seederçµæœ

### dbã‚³ãƒ³ãƒ†ãƒŠã«å…¥ã‚‹

```bash:root@27c72a17e24e:/work#
docker-compose exec db bash 
```

### mySQLæ¥ç¶š

```bash:bash-4.4#
bash-4.4# mysql -u root -p
# password ã¨å…¥åŠ›ã—ã¦Enter
Enter password: 
```

## ç™»éŒ²æƒ…å ±ã‚’å‚ç…§

```bash:mysql>
mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| laravel_local      |
| mysql              |
| performance_schema |
| sys                |
+--------------------+

use laravel_local;

 show tables;
+-------------------------+
| Tables_in_laravel_local |
+-------------------------+
| failed_jobs             |
| migrations              |
| password_resets         |
| personal_access_tokens  |
| shops                   |
| users                   |
+-------------------------+

mysql> select * from shops;
+----+--------------------+-----+-----------+---------------------+---------------------+-------------------------------+
| id | name               | age | gender_id | created_at          | updated_at          | free_word                     |
+----+--------------------+-----+-----------+---------------------+---------------------+-------------------------------+
|  1 | ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ       |  25 |         1 | 2022-01-02 00:57:29 | 2022-01-02 00:57:29 | 25 ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ ç”·æ€§          |
|  2 | ã‚µãƒ³ãƒ—ãƒ«èŠ±å­       |  30 |         2 | 2022-01-02 00:57:29 | 2022-01-02 00:57:29 | 30 ã‚µãƒ³ãƒ—ãƒ«èŠ±å­ å¥³æ€§          |
|  3 | ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ       |  20 |         1 | 2022-01-02 00:57:29 | 2022-01-02 00:57:29 | 20 ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ ç”·æ€§          |
+----+--------------------+-----+-----------+---------------------+---------------------+-------------------------------+
3 rows in set (0.00 sec)
```

## Routeã‚’å®šç¾©

https://readouble.com/laravel/8.x/ja/routing.html

```php:backend/routes/web.php
<?php

use Illuminate\Support\Facades\Route;

/*
|--------------------------------------------------------------------------
| Web Routes
|--------------------------------------------------------------------------
|
| Here is where you can register web routes for your application. These
| routes are loaded by the RouteServiceProvider within a group which
| contains the "web" middleware group. Now create something great!
|
*/

Route::get('/', function () {
    return view('welcome');
});

Route::get('/admin', [\App\Http\Controllers\ShopController::class, 'index']);
```

## Controllerã‚’å®šç¾©

- ä»Šå›ã¯`Controller`ã«ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ãŒã€`useCaseå±¤`ç­‰ã«åˆ†é›¢ã•ã›ãŸæ–¹ãŒã„ã„ã§ã™


https://zenn.dev/mpyw/articles/ce7d09eb6d8117

https://readouble.com/laravel/8.x/ja/controllers.html

```php:backend/app/Http/Controllers/ShopController.php
<?php

namespace App\Http\Controllers;

use App\Models\Shop;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\Request;

class ShopController extends Controller
{
    /**
     * æ¤œç´¢
     * @param Request $request
     * @return Application|Factory|View
     */
    public function index(Request $request)
    {
        $query = Shop::query();
        $freeWord = $request->input('free_word');

        if ($freeWord) {
            $query->whereRaw("match(`free_word`) against (? IN BOOLEAN MODE)", $freeWord);
        }

        $shops = $query
            ->select(['id', 'name', 'age', 'gender_id'])
            ->paginate(20, ['*'], 'page', 1);

        $param = collect($request->input());
        $shops->appends($request->input());

        return view('index', ['shops' => $shops, 'parameters' => $param]);
    }
}
```

## Controllerã‚’å®šç¾©:è£œè¶³

`whereRaw`:ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ã«ç›´æ¥SQLæ–‡ã‚’æŒ‡å®šã—ã¾ã™(å¿…ãšãƒ—ãƒªãƒšã‚¢ãƒ‰ã‚¹ãƒ†ãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„ï¼‰


https://e-words.jp/w/%E3%83%97%E3%83%AA%E3%83%9A%E3%82%A2%E3%83%89%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%83%A1%E3%83%B3%E3%83%88.html

:::message alert
rawãƒ¡ã‚½ãƒƒãƒ‰ã¯ã‚¯ã‚¨ãƒªã‚’æ–‡å­—åˆ—ã¨ã—ã¦æŒ¿å…¥ã™ã‚‹ãŸã‚ã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®è„†å¼±æ€§ã‚’ç”Ÿã¾ãªã„ã‚ˆã†ã«ååˆ†æ°—ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚
:::

https://readouble.com/laravel/7.x/ja/queries.html

https://dev.mysql.com/doc/refman/8.0/ja/fulltext-boolean.html

```php:backend/app/Http/Controllers/ShopController.php
$query->whereRaw("match(`free_word`) against (? IN BOOLEAN MODE)", $freeWord);
```

## Viewã®å®šç¾©

```php:backend/resources/views/index.blade.php
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Laravel</title>
    <link href="{{ asset('css/app.css') }}" rel="stylesheet">
    <script src="{{ asset('js/app.js') }}"></script>
</head>
<body>
<div class="container">
    <div class="card center-block">
        <div class="card-header">
            Featured
        </div>
        <div class="card-body">
            <form action="/admin" method="Get">
                <div class="mb-2">
                    <label for="free_word" class="form-label">å…¨æ–‡æ¤œç´¢</label>
                    <input type="text" class="form-control" name="free_word" id="free_word"
                           value="{{$parameters->get('free_word')}}">
                </div>
                <input type="submit" class="btn btn-primary" value="æ¤œç´¢">
                <a href="/admin" class="btn btn-secondary">æ¤œç´¢æ¡ä»¶ã‚¯ãƒªã‚¢</a>
            </form>
        </div>
    </div>
    <br>
    <div>
        <div>æ¤œç´¢çµæœã¯{{$shops->total()}}ä»¶ã§ã™ã€‚</div>
        <div>
            <table class="table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>åå‰</th>
                    <th>å¹´é½¢</th>
                    <th>æ€§åˆ¥</th>
                </tr>
                </thead>
                <tbody>
                @foreach($shops as $shop)
                    <tr>
                        <td>{{$shop->id}}</td>
                        <td>{{$shop->name}}</td>
                        <td>{{$shop->age}}</td>
                        <td>{{$shop->gender_id ===1 ? 'ç”·æ€§':'å¥³æ€§'}}</td>
                    </tr>
                @endForeach
                </tbody>
            </table>
        </div>
    </div>
</div>
</body>
</html>
```

`ç”·æ€§ 2`ã§æ¤œç´¢ã™ã‚‹ã¨å®Œå…¨ä¸€è‡´ã§ãªã„ã‚‚ã®ã‚‚æ¤œç´¢ã—ã¦ãã‚Œã¾ã™!
ã¾ãŸ`Index`ã‚’åˆ©ç”¨ã—ã¦æ¤œç´¢ã—ã¦ãã‚Œã‚‹ã®ã§`LIKE`æ¤œç´¢ã«æ¯”ã¹ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒé«˜ã„ã‚ˆã†ã§ã™

https://tech.bita.jp/article/4

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-02 1.30.07.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/d5b6fab1-c207-2fa8-b3a8-a649a0fd5770.png)

# ãŠã‚ã‚Šã«
ä»Šå›ã¯MySQLã®å…¨æ–‡æ¤œç´¢æ©Ÿèƒ½+Laravelã«ã¤ã„ã¦ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚

Laravelã®ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã¨SQLã‚’æ›¸ã‹ãªãã¦ã‚‚ã„ã„æ„Ÿã˜ã«ã‚„ã£ã¦ãã‚Œã‚‹åé¢ã€ç‰¹æ®Šãªå¯¾å¿œãŒå¿…è¦ãªå ´åˆã¯`SQL`ã®çŸ¥è­˜ãƒ»çµŒé¨“ãŒå¿…è¦ãªã®ã§æ—¥ã€…å‹‰å¼·ã®æ¯æ—¥ã§ã™ã€‚ã€‚ã€‚
ã“ã®è¨˜äº‹ãŒèª°ã‹ã®ãŠå½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™
