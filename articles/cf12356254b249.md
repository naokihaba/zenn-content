---
title: "ã€GCPã€‘CloudSQLã®ä½œæˆã€œGCEã¨ã®é€£æºã‚’è¡Œã†å‚™å¿˜éŒ²"
emoji: "ğŸ“”"
type: "tech"
topics:
  - "gcp"
  - "gce"
  - "gcs"
published: true
published_at: "2022-01-13 04:08"
---

# ã¯ã˜ã‚ã«

ã‚¤ãƒ³ãƒ•ãƒ©å‘¨ã‚Šã‚’è§¦ã‚‹ã“ã¨ãŒå¢—ãˆã¦ããŸã®ã§å­¦ç¿’ã®å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¦ã„ã¾ã™

https://www.udemy.com/share/102dyS3@Fqxih5w5xCgeN-LuioLMABTv3vidCvgFPQ4P5ZUogMSwZxZzYM3cBLrxW-neks30/

# ã‚„ã‚Šæ–¹

# `CloudSQL`æ§‹ç¯‰

## ä»»æ„ã®DBã‚¨ãƒ³ã‚¸ãƒ³ã‚’é¸æŠã™ã‚‹
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 2.23.31.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/a7704f82-01b3-b96d-da76-7c5480cb83b7.png)

## ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 2.27.53.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/20d25a3e-2202-8653-d3f4-6991b533edc4.png)

## DBã‚’ä½œæˆ
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 2.48.47.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/392a3f33-db3c-758e-4d0b-26d1d0e53b3e.png)

## `Cloud SQL Admin API`ã‚’æœ‰åŠ¹ã«ã™ã‚‹

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 2.53.31.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/6b2ca82a-9daa-405d-6aca-5712740f3954.png)

æœ‰åŠ¹ã«ã—ã¦ã„ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™

```bash
https://console.developers.google.com/apis/api/sqladmin.googleapis.com/overview?project=640010116609 then retry. If you enabled this API recently, wait a few minutes for the action to propagate to our systems and retry.
```

## `CLOUD SHELL`ã‚’é–‹ã

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 2.57.40.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/f9443370-d09f-7cb2-4842-7ff1b8801759.png)

## DBã«æ¥ç¶š

```bash
gcloud sql connect demo --user=root --quiet
Allowlisting your IP for incoming connection for 5 minutes...done.     
Connecting to database with SQL user [root].Enter password:

mysql>
```
## DBã‚’æ“ä½œã™ã‚‹

```sql
-- DBä¸€è¦§ã‚’è¡¨ç¤º
show databases;
+--------------------+
| Database           |
+--------------------+
| demo               |
| information_schema |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.04 sec)

-- DBã‚’åˆ‡ã‚Šæ›¿ãˆ
use demo;
Database changed

-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
CREATE TABLE users (id int NOT NULL PRIMARY key AUTO_INCREMENT,name VARCHAR(255));

-- ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç™»éŒ²
INSERT INTO users(name) VALUES('hoge');

-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
mysql> SELECT * FROM users;
+----+------+
| id | name |
+----+------+
|  1 | hoge |
+----+------+
1 row in set (0.03 sec)
```

# `GCE`ã‹ã‚‰`Cloud SQL`ã«æ¥ç¶šã™ã‚‹

## `VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹`ã®å¤–éƒ¨IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«è¿½åŠ ã™ã‚‹


![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 3.25.05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/0357b592-aebe-5b4c-3e75-427a92cf1f61.png)

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 3.26.12.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/eddd2378-1ede-0f1f-96a9-c8d8ca6af23a.png)

## `GCE`ã«`mysql-client`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
sudo su -

# mariadb-clientã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«(mysql-clientãŒçµ±åˆã•ã‚Œã¦ã„ã‚‹)
apt-get -y install mariadb-client

# SQLã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—SQLã«æ¥ç¶š
mysql -u root -h ãƒ‘ãƒ–ãƒªãƒƒã‚¯ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ -p

# æ¥ç¶šæˆåŠŸ
MySQL [(none)]> 
```

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 3.28.43.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/ccb2c919-2f25-b8c1-88aa-455e6c9bd958.png)


# `GCE`ã‹ã‚‰`CloudSQL`ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹

## `php-mysql`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

```bash
sudo su -

# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ä¸€è¦§ã‚’æ›´æ–°
apt-get -y update

# ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
apt-get -y install php-mysql

# Apacheã‚’å†èµ·å‹•
systemctl restart httpd.service	
```

## `CloudSQL`ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ãƒ»è¡¨ç¤ºã™ã‚‹

```php
<?php
try {
    $pdo = new PDO('mysql:host='ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚¢ãƒ‰ãƒ¬ã‚¹å';dbname='DBå';charset=utf8','ãƒ¦ãƒ¼ã‚¶å','ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰',
      [(PDO::ATTR_EMULATE_PREPARES => false)];
      echo "æˆåŠŸ";
    } catch (PDOException $e) {
    echo "å¤±æ•—";
}
?>

<?php
$stmt = $pdo->query("SELECT * FROM users");
while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
    echo "<p>";
    echo $row["name"];
    echo "</p>";
}
?>
```

`CloudSQL`ã«ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã§ãã‚Œã°æˆåŠŸ

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 4.03.18.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/78bb01df-203b-60a4-67a0-b9bd28125627.png)
