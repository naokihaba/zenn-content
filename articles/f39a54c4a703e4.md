---
title: "Auth0ã®SDKã‚’ä½¿ã£ã¦NestJSã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç™»éŒ²ã™ã‚‹æ–¹æ³•"
emoji: "ğŸˆ"
type: "tech"
topics:
  - "graphql"
  - "typescript"
  - "hasura"
  - "nestjs"
  - "auth0"
published: false
published_at: "2022-10-12 21:30"
---

# ã¯ã˜ã‚ã«

`Auth0`ã®SDKã‚’åˆ©ç”¨ã—ã¦`Auth0 Management API`ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’AUth0ã®DBã«ç™»éŒ²ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã™ã€‚

å‚è€ƒè³‡æ–™ã¯ã“ã¡ã‚‰

https://dev.classmethod.jp/articles/manage-auth0-users-using-auth0-management-api-with-nodejs/

## å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

https://www.npmjs.com/package/auth0

https://www.npmjs.com/package/@types/auth0

## `Auth0`ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®šç¾©ã™ã‚‹

ç’°å¢ƒå¤‰æ•°ã«ã¤ã„ã¦ã¯[Configuration](https://docs.nestjs.com/techniques/configuration)ã‚’åˆ©ç”¨ã—ã¦èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™

`Auth0`ã®`ManagementClient`ã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹ãŸã‚ã®`domain`ãƒ»`clientId`ãƒ»`clientSecret`ã«ã¤ã„ã¦ã¯å†’é ­ã®å‚è€ƒè³‡æ–™ã«ç´°ã‹ãèª¬æ˜ã•ã‚Œã¦ã„ã‚‹ã®ã§ãã¡ã‚‰ã‚’å‚ç…§ãã ã•ã„

ç’°å¢ƒå¤‰æ•°ã«ã¤ã„ã¦ã¯æœ¬ç•ªç’°å¢ƒãƒ»æ¤œè¨¼ç’°å¢ƒã”ã¨ã«`Cloud Run`ã«è¨­å®šã—ãŸç’°å¢ƒå¤‰æ•°ã‚’ã‚‚ã¨ã«ãƒ—ãƒ­ã‚»ã‚¹ã‹ã‚‰èª­ã¿è¾¼ã‚€ã“ã¨ã‚’æƒ³å®šã—ã¦ã„ã¾ã™

https://cloud.google.com/run/docs/configuring/environment-variables?hl=ja

:::details ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹

```ts:app/src/common/auth0/auth0.module.ts
import { Module } from '@nestjs/common'
import { LoggerModule } from 'nestjs-pino'
import { ConfigModule } from '@nestjs/config'
import { Auth0Service } from './auth0.service'

@Module({
  providers: [Auth0Service],
  exports: [Auth0Service],
  imports: [LoggerModule, ConfigModule],
})
export class Auth0Module {}
```
:::

:::details ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹
```ts:app/src/common/auth0/auth0.service.ts
import { Injectable, InternalServerErrorException } from '@nestjs/common'
import { ConfigService } from '@nestjs/config'
import { ManagementClient } from 'auth0'
import { CreateAuth0UserInput } from '../../types/auth0/CreateAuth0UserInput'
import { CreateAuth0UserOutput } from '../../types/auth0/CreateAuth0UserOutput'

@Injectable()
export class Auth0Service {
  private readonly auth0Client: ManagementClient
  private readonly AUTH0_CONNECTION = 'Username-Password-Authentication'

  constructor(private configService: ConfigService) {
    this.auth0Client = new ManagementClient({
      domain: this.configService.get('auth0.domain'),
      clientId: this.configService.get('auth0.clientId'),
      clientSecret: this.configService.get('auth0.clientSecret'),
      scope: 'create:users read:users update:users',
    })
  }

  async createUserByAuth0({
    email,
    password,
  }: CreateAuth0UserInput): Promise<CreateAuth0UserOutput> {
    try {
      const { user_id } = await this.auth0Client.createUser({
        connection: this.AUTH0_CONNECTION,
        email: email,
        password: password,
      })

      return {
        user_id: user_id,
      }
    } catch (e: unknown) {
      if (e instanceof Error) {
        throw new InternalServerErrorException(e.message)
      }
      
      throw new InternalServerErrorException(e)
    }
  }
}
```
:::

## `Resolver`ã‚’å®šç¾©ã™ã‚‹

ä»Šå›ã¯`GraphQL`ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚`Resolver`ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ãŒã€`RestAPI`ã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã®æ‰‹é †ã¯ä¸è¦ã«ãªã‚Šã¾ã™ã€‚
ä½¿ç”¨ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å…ˆã»ã©å®šç¾©ã—ãŸ`Auth0`ã‚’æ“ä½œã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä¾å­˜æ³¨å…¥ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚


:::details InputType
```ts:app/src/types/auth0/CreateAuth0UserInput.ts
import { Field, InputType } from '@nestjs/graphql'

@InputType()
export class CreateAuth0UserInput {
  @Field()
  email: string

  @Field()
  password: string
}
```
:::

:::details ObjectType
```ts:app/src/types/auth0/CreateAuth0UserOutput.ts
import { Field, ObjectType } from '@nestjs/graphql'

@ObjectType()
export class CreateAuth0UserOutput {
  @Field()
  user_id: string
}
```
:::

:::details ãƒªã‚¾ãƒ«ãƒã‚¯ãƒ©ã‚¹
```ts:app/src/author/author.resolver.ts
import { Args, Int, Mutation, Query, Resolver } from '@nestjs/graphql'
import { AuthorService } from './author.service'
import { Author } from './author.model'
import { CreateAuth0UserInput } from '../types/auth0/CreateAuth0UserInput'
import { Auth0Service } from '../common/auth0/auth0.service'
import { CreateAuth0UserOutput } from '../types/auth0/CreateAuth0UserOutput'

@Resolver(() => Author)
export class AuthorsResolver {
  constructor(
    private readonly authorsService: AuthorService,
    private readonly auth0Service: Auth0Service,
  ) {}

  @Query(() => String)
  async author() {
    return 'hoge'
  }

  @Mutation((returns) => CreateAuth0UserOutput)
  async saveUserByAuth0(
    @Args('auth0Data') auth0InputData: CreateAuth0UserInput,
  ) {
    return this.auth0Service.createUserByAuth0(auth0InputData)
  }
}
```
:::

:::details ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹
```ts:app/src/author/author.module.ts
import { Module } from '@nestjs/common'
import { AuthorService } from './author.service'
import { AuthorsResolver } from './author.resolver'
import { Auth0Module } from '../common/auth0/auth0.module'

@Module({
  imports: [Auth0Module],
  providers: [AuthorsResolver, AuthorService],
})
export class AuthorModule {}
```
:::

## å®Ÿè¡Œã—ã¦ã¿ã‚‹

æˆåŠŸã™ã‚‹ã¨`Autho`ã§ç™ºè¡Œã•ã‚ŒãŸIDãŒè¿”å´ã•ã‚Œã¾ã™

```graphql
mutation MyMutation {
  saveUserByAuth0(auth0Data: {email: "hoge8@example.com", password: "Password1234"}) {
    user_id
  }
}
```
