---
title: "ã€GCPã€‘DataStoreã®Kindã‚’DataFlowã§å‰Šé™¤ã™ã‚‹ã‚¢ãƒ¬ã‚³ãƒ¬"
emoji: "ğŸ¤–"
type: "tech"
topics:
  - "gcp"
  - "dataflow"
  - "datastore"
published: true
published_at: "2022-07-13 20:27"
---

# æ¦‚è¦

`DataStore`ã®`kind`ã‚’ä¸€æ‹¬ã§å‰Šé™¤ã™ã‚‹ãŸã‚ã®`DataFlow`ã‚’ä½œæˆã—ãŸéš›ã®ã‚¢ãƒ¬ã‚³ãƒ¬ã‚’ã¾ã¨ã‚ã‚‹

è¨­å®šã«ã¤ã„ã¦ã¯ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸ

https://techblog.ap-com.co.jp/entry/2019/01/17/000000

# è¨­å®šé …ç›®

- ã‚¸ãƒ§ãƒ–å
    - ä»»æ„ã®ã‚¸ãƒ§ãƒ–å
- ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    - ä»»æ„ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³
- Dataflowãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
    - Bulk Delete Entities in Datastore [Deprecated]
- GQL Query
    - SELECT * FROM `kindå`
- Read data from Datastore Project Id
    - å‰Šé™¤ã™ã‚‹DataStoreã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
- Delete all matching entities from the GQL Query present in this Datastore Project Id of
    - å‰Šé™¤ã™ã‚‹DataStoreã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
- ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ãªå ´æ‰€
    - ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãè¾¼ã‚€ãŸã‚ã®GCSã®ãƒã‚±ãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«
    - `Dataflow ãƒ¯ãƒ¼ã‚«ãƒ¼`æ¨©é™ã‚’ä»˜ä¸ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’æŒ‡å®š
    - `Dataflow ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼`æ¨©é™ã‚‚ä»˜ä¸ã—ã¦å½“æ–¹ã¯è¨­å®šã—ãŸãŒæã‚‰ãä¸è¦
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    - ã”è‡ªèº«ã®VPCã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å
- ã‚µãƒ–ãƒãƒƒãƒˆ
    - - ã”è‡ªèº«ã®VPCã®ã‚µãƒ–ãƒãƒƒãƒˆå

# `DataFlow`çµŒç”±ã§`GQL`ã‚’å®Ÿè¡Œã—ã¦ãã‚Œã‚‹

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-07-13 20.20.36.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/546ec41f-7185-fe2d-35b0-a1f5e0f26ba5.png)


# é­é‡ã—ãŸã‚¨ãƒ©ãƒ¼å†…å®¹

å¯¾å‡¦æ–¹æ³•ï¼š`Dataflow API`ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä»˜ä¸ã—ãŸæ¨©é™ãŒä¸è¶³ã—ã¦ã„ãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹

```bash
â€œWorkflow failed. Causes: There was a problem refreshing your credentials. Please check:
1. Dataflow API is enabled for your project.
2. Make sure both the Dataflow service account and the controller service account have sufficient permissions. If you are not specifying a controller service account, ensure the default Compute Engine service account [PROJECT_NUMBER]-compute@developer.gserviceaccount.com exists and has sufficient permissions. If you have deleted the default Compute Engine service account, you must specify a controller service account. For more information, see: https://cloud.google.com/dataflow/docs/concepts/security-and-permissions#security_and_permissions_for_pipelines_on_google_cloud_platform. , There is no cloudservices robot account for your project.  Please ensure that the Dataflow API is enabled for your project.â€
```

å¯¾å‡¦æ–¹æ³•ï¼šãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ»ã‚µãƒ–ãƒãƒƒãƒˆã®ã©ã¡ã‚‰ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ç™ºç”Ÿã™ã‚‹ã®ã§è¨­å®šã‚’ç¢ºèªã™ã‚‹

```bash
Workflow failed. Causes: Network default is not accessible to Dataflow Service account or does not exist
```

å¯¾å‡¦æ–¹æ³•ï¼šIAMã§ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾ã—ã¦ä»˜ä¸ã—ãŸæ¨©é™ãŒä¸è¶³ã—ã¦ã‚‹ã®ã§ç¢ºèªã™ã‚‹

```bash
Permissions verification for controller service account failed. All permissions in IAM role roles/dataflow.worker should be granted to controller service account hogehoge@fugafuga.iam.gserviceaccount.com.
```
