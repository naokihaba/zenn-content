---
title: "Terraform workspaceã‚’ä½¿ã£ã¦ã€å€‹äººã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¦ã¿ã‚‹"
emoji: "ğŸˆ"
type: "tech"
topics:
- "AWS"
- "Terrafom"
published: true
---

# æ¦‚è¦

Terraform ã«ã¯ã€workspaceã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚

https://developer.hashicorp.com/terraform/language/state/workspaces

å€‹äººã”ã¨ã«å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†ã‘ã¦ã„ãã®ã¯ã€1åãƒ»2åã®å ´åˆã¯å•é¡Œãªã„ã®ã§ã™ãŒã€10åã¨ã‹ã«ãªã‚‹ã¨ã€ç®¡ç†ãŒå¤§å¤‰ã«ãªã£ã¦ãã¾ã™ã€‚

ãã“ã§ã€workspaceã‚’ä½¿ã£ã¦ã€å€‹äººã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã—ã¦ã¿ã¾ã—ãŸã€‚

# äº‹å‰æº–å‚™

## AWS IAMã®è¨­å®š

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/id_users_create.html

## AWS Cliã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```shell
$ sudo easy_install pip
$ sudo pip install awscli

# or

$ brew install awscli
```

## AWS CLIã®profileã®è¨­å®š

```shell
$ aws configure --profile <profileå>

AWS Access Key ID [None]: ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ ID
AWS Secret Access Key [None]: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼
Default region name [None]: ap-northeast-1
Default output format [None]: json
```

## Terraformã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

tfenvã‚’ä½¿ã£ã¦ã€Terraformã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚

https://github.com/tfutils/tfenv

```shell
$ brew install tfenv
$ tfenv install # ä»»æ„ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ ex 1.0.4
$ tfenv use # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ ex 1.0.4
```

# workspaceã®ä½œæˆ

https://developer.hashicorp.com/terraform/cli/commands/workspace

```shell
$ terraform workspace new <workspaceå>

# ä¾‹
$ terraform workspace new test
Created and switched to workspace "test"!

$ terraform workspace list       
  default
* test
```

# ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š

AWSã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¦ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```shell
$ mkdir terraform
$ cd terraform
$ touch main.tf
```

```terraform:main.tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 4.0"
    }
  }
}

provider "aws" {
  region = "ap-northeast-1"
  profile = "default"
}
```

# ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ

ä»Šå›ã¯ã€VPCã€€ã¨ã€€å€‹äººã”ã¨ã®ALB target groupã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

å…ˆã»ã©ã®ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

```shell
$ touch vpc.tf
$ touch alb.tf
```

## VPCã®ä½œæˆ

```terraform:vpc.tf
resource "aws_vpc" "test" {
  cidr_block = "10.0.0.0/16"

  tags = {
    Name = "test"
  }
}
```

## ALB target groupã®ä½œæˆ

`variable` ã§å®Ÿè¡Œæ™‚ã«å€‹äººåã‚’æŒ‡å®šã—ã¦ã‚‚ã‚‰ã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ALBã®å ´åˆã¯ã€32æ–‡å­—ã¾ã§ã—ã‹æŒ‡å®šã§ããªã„ã®ã§ã€æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

```terraform:alb.tf
variable "personal_name_prefix" {
  type        = string
  description = <<-EOF
    å€‹äººç’°å¢ƒã”ã¨ã®Prefixã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
    æŒ‡å®šæ–¹æ³•ï¼š[firstname]-[lastname]
  EOF
}

resource "aws_alb_target_group" "test" {
  name     = var.personal_name_prefix
  port     = 80
  protocol = "HTTP"
  vpc_id   = aws_vpc.test.id
}
```

# å®Ÿè¡Œè¨ˆç”»ã®ç¢ºèª

ä»Šå›ã¯æ–°è¦ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã§ã€`terraform plan` ã§å®Ÿè¡Œè¨ˆç”»ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

```shell
$ terraform plan -var personal_name_prefix=test

terraform plan -var personal_name_prefix=test

Terraform used the selected providers to generate the following execution plan. Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # aws_alb_target_group.test will be created
  + resource "aws_alb_target_group" "test" {
      + arn                                = (known after apply)
      + arn_suffix                         = (known after apply)
      
      # ä»¥ä¸‹å‰²æ„›
    }

  # aws_vpc.test will be created
  + resource "aws_vpc" "test" {
      + arn                                  = (known after apply)
      + cidr_block                           = "10.0.0.0/16"
      
      # ä»¥ä¸‹å‰²æ„›
    }

Plan: 2 to add, 0 to change, 0 to destroy.
```

# ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ

`terraform apply` ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚

```shell
$ terraform apply -var personal_name_prefix=test

~~~ çœç•¥ ~~~
Apply complete! Resources: 2 added, 0 changed, 0 destroyed.
```

# çµæœ

ãƒªã‚½ãƒ¼ã‚¹ãŒAWSä¸Šã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ã‚ˆã£ã¦ã€å€‹äººã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

```shell
$ terraform workspace list
  default
* test
 
# terraform.tfstate.d ã«ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã”ã¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
$ ls terraform.tfstate.d/
  test
```

# ãŠæƒé™¤

ä½¿ã‚ãªã„ãƒªã‚½ãƒ¼ã‚¹ã¯ã€`terraform destroy` ã§å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚

```shell
$ terraform destroy -var personal_name_prefix=test

Destroy complete! Resources: 1 destroyed.
```

# ã¾ã¨ã‚

workspaceã‚’ä½¿ã†ã“ã¨ã§ã€å€‹äººã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

ä»Šå›ã¯ã€VPCã¨ALB target groupã‚’ä½œæˆã—ã¾ã—ãŸãŒã€ä»–ã«ã‚‚ã€EC2ã‚„RDSãªã©ã€å€‹äººã”ã¨ã«ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãŒã‚ã‚Œã°ã€workspaceã‚’ä½¿ã£ã¦ç®¡ç†ã™ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚


