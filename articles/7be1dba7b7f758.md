---
title: "ã€Laravel + PHPUnitã€‘Unitãƒ»Featureãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦GitHubActionsã§CI/CDç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹è©±"
emoji: "ğŸ—‚ï¸"
type: "tech"
topics:
  - "laravel"
  - "test"
  - "githubactions"
  - "phpunit"
published: true
published_at: "2022-03-24 01:58"
---

# æ¦‚è¦

`PHPUnit`ã‚’åˆ©ç”¨ã—ãŸ`CI/CD`ç’°å¢ƒã®æ§‹ç¯‰ã¾ã§ã‚’ã¾ã¨ã‚ã¾ã™

# ç’°å¢ƒ

- PHP 7.4.25
- Laravel Framework 6.20.44

# `Factory` ã§ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã™ã‚‹

https://readouble.com/laravel/6.x/ja/database-testing.html

## `Factory`ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ

```bash
php artisan make:factory UserFactory
```

## `Factory`ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©

https://github.com/fzaninotto/Faker

```php:src/laravel/database/factories/UserFactory.php
<?php

/** @var \Illuminate\Database\Eloquent\Factory $factory */

use App\Models\User;
use Faker\Generator as Faker;
use Illuminate\Support\Str;

/*
|--------------------------------------------------------------------------
| Model Factories
|--------------------------------------------------------------------------
|
| This directory should contain each of the model factory definitions for
| your application. Factories provide a convenient way to generate new
| model instances for testing / seeding your application's database.
|
*/

$factory->define(User::class, function (Faker $faker) {
    return [
        'name' => $faker->name,
        'email' => $faker->unique()->safeEmail,
        'email_verified_at' => now(),
        'password' => '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', // password
        'remember_token' => Str::random(10),
    ];
});
```

# èªè¨¼æ©Ÿèƒ½ã®å¯¾è±¡ã®ãƒ¢ãƒ‡ãƒ«ã‚’ç·¨é›†

`Authenticatable` ã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¾ã™ã€‚

å¾Œè¿°ã™ã‚‹ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã§`actingAs()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’åˆ©ç”¨ã—ãŸèªè¨¼æ™‚ã®ã‚¨ãƒ©ãƒ¼å¯¾ç­–ã§ã™ã€‚

> TypeError: Argument 1 passed to Illuminate\Foundation\Testing\TestCase::actingAs() must be an instance of Illuminate\Contracts\Auth\Authenticatable, instance of App\Models\User given


```php:src/laravel/app/Models/User.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use SoftDeletes;

    /**
     * ãƒ¢ãƒ‡ãƒ«ã¨é–¢é€£ã—ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
     *
     * @var string
     */
    protected $table = 'users';
   
    protected $fillable = [
        'name',
        'email',
        'email_verified_at',
        'password',
    ];
}
```

# `Unit`ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…

## ãƒ†ã‚¹ãƒˆå¯¾è±¡ã‚¯ãƒ©ã‚¹

```php:app/Domains/Master.php
class Sample implements Master
{
    private int $id;

    public const ROLES = [
        1 => 'hoge',
        2 => 'fuga',
    ];

    public static function getNameById(int $id): string
    {
        return self::ROLES[$id];
    }

    public static function getIdByName(string $name): int
    {
        return array_search($name, self::ROLES);
    }

    /**
     * @throws BadRequestException
     */
    public function __construct(int $id)
    {
        $max = count(self::ROLES);

        if ($id < 1) {
            throw new BadRequestException('idã®å€¤ãŒ1ä»¥ä¸‹ã§ã™');
        }

        if ($id > $max) {
            throw new BadRequestException("idã®å€¤ãŒ{$max}ä»¥ä¸Šã§ã™");
        }

        $this->id = $id;
    }

    public function getId(): int
    {
        return $this->id;
    }

    public function getName(): string
    {
        return self::getNameById($this->id);
    }
}
```

## ãƒ†ã‚¹ãƒˆ


```php:src/laravel/tests/Unit/SampleTest.php
use PHPUnit\Framework\TestCase;

class SampleTest extends TestCase
{
    protected function setUp(): void
    {
        parent::setUp();
    }

    public function test_NG_ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«å¼•æ•°ã‚’æ¸¡ã—ã¦ã„ãªã„()
    {
        $this->expectException(\ArgumentCountError::class);
        new UserRole();
    }

    public function test_OK_getId()
    {
        $id = 1;
        $userRole = new UserRole($id);
        $this->assertEquals($id, $userRole->getId());
    }

    public function test_OK_getName()
    {
        $id = 1;
        $name = UserRole::getNameById($id);
        $userRole = new UserRole($id);
        $this->assertEquals($name, $userRole->getName());
    }
}
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
./vendor/bin/phpunit tests/Unit/

Time: 00:00.145, Memory: 8.00 MB

OK (3 tests, 3 assertions)
```

# `Feature`ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…

https://readouble.com/laravel/6.x/ja/http-tests.html

```php:src/laravel/tests/Feature/UserControllerTest.php
<?php

namespace Tests\Feature\Admin\Users;

use App\Http\Middleware\VerifyCsrfToken;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Tests\TestCase;

class UserControllerTest extends TestCase
{
    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã”ã¨ã«DBã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
    use RefreshDatabase;

    public const INDEX_PATH = 'admin/users';
    public const INDEX_VIEW_NAME = 'admin.users.index';
    public const SHOW_VIEW_NAME = 'admin.users.show';
    public const EDIT_VIEW_NAME = 'admin.users.edit';

    protected function setUp(): void
    {
        parent::setUp();

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        $this->authUser = factory(User::class)->create();
        $this->unAuthUser = factory(User::class)->create();
    }

    public function test_NG_ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„å ´åˆã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„()
    {
        $response = $this->get(self::INDEX_PATH);
        $response->assertStatus(302);
    }

    public function test_OK_ä¸€è¦§ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹()
    {
        $response = $this->actingAs($this->authUser)->get(self::INDEX_PATH);
        $response->assertOk();
        $response->assertViewIs(self::INDEX_VIEW_NAME);
    }

    public function test_OK_æ¤œç´¢()
    {
        $name = User::first()->name;
        $path = "admin/users?name=${name}";
        $response = $this->actingAs($this->authUser)->get($path);
        $response->assertOk();
        $response->assertSee($name);
        $response->assertViewIs(self::INDEX_VIEW_NAME);
    }

    public function test_OK_è©³ç´°()
    {
        $id = User::query()->first()->id;
        $path = "admin/users/${id}";
        $response = $this->actingAs($this->authUser)->get($path);
        $response->assertOk();
        $response->assertViewIs(self::SHOW_VIEW_NAME);
    }

    public function test_OK_ç™»éŒ²()
    {
        $path = "admin/users/edit";
        $response = $this->actingAs($this->authUser)->get($path);
        $response->assertOk();
        $response->assertViewIs(self::EDIT_VIEW_NAME);
    }

    public function test_OK_ç·¨é›†()
    {
        $id = User::query()->first()->id;
        $path = "admin/users/edit/${id}";
        $response = $this->actingAs($this->authUser)->get($path);
        $response->assertOk();
        $response->assertViewIs(self::EDIT_VIEW_NAME);
    }

    public function test_OK_ç™»éŒ²æˆåŠŸ()
    {
        // POSTæ™‚ã«419ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã®ã§CSRFãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ç„¡åŠ¹ã«ã™ã‚‹
        $this->withoutMiddleware([VerifyCsrfToken::class]);

        $path = "admin/users/store";
        $response = $this->actingAs($this->authUser)
            ->post(
                $path,
                [
                    "name" => 'ãƒ†ã‚¹ãƒˆ',
                    "email" => "test@example.com",
                    "password" => 'password',
                ]
            );
        $response->assertOk();
    }

    public function test_OK_æ›´æ–°æˆåŠŸ()
    {
        $this->withoutMiddleware([VerifyCsrfToken::class]);

        $path = "admin/users/store";
        $response = $this->actingAs($this->authUser)
            ->post(
                $path,
                [
                    "name" => 'ãƒ†ã‚¹ãƒˆ',
                    "email" => "test@example.com",
                    "password" => 'password',
                    'base_user_id' => $this->authUser->id,
                ]
            );
        $response->assertOk();
    }
}
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
phpdbg -qrr ./vendor/bin/phpunit --coverage-text

Time: 00:00.145, Memory: 8.00 MB

OK (8 tests, 8 assertions)
```

# `GitHubActions`ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©

```yml:.github/workflows/main.yml
name: CodeCheck

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: dokcer-compose up
        run: |
          # docker-compose build
          docker-compose up -d
      - name: composer install
        run: |
          docker-compose exec -T laravel bash -c "composer install"
      - name: phpunit
        run: |
          docker-compose exec -T laravel bash -c "phpdbg -qrr ./vendor/bin/phpunit --coverage-text"
```
