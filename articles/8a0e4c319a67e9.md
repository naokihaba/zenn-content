---
title: "Laravel + Docker + PHPUnit + GitHubActions ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’PRã«å‡ºåŠ›ã™ã‚‹"
emoji: "ðŸ—‚ï¸"
type: "tech"
topics:
  - "docker"
  - "laravel"
  - "php"
  - "githubactions"
  - "phpunit"
published: true
published_at: "2022-04-13 01:34"
---

# æ¦‚è¦

å…ˆæ—¥ã€[phperkaigi2022](https://phperkaigi.jp/2022/)ã«å‚åŠ ã—ã¦ãƒ†ã‚¹ãƒˆçµæžœã®è¦‹ãˆã‚‹åŒ–ã¨ãƒ†ã‚¹ãƒˆæ–‡åŒ–ã‚’æ ¹ä»˜ã‹ã›ã‚‹ãŸã‚ã®æ´»å‹•ãŒã‚ˆã‹ã£ãŸã®ã§ã€å®Ÿéš›ã«å°Žå…¥ã—ã¦ã¿ãŸ

ãªãŠã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã¤ã„ã¦ã‚‚ã£ã¨è‰¯ã„æ–¹æ³•ã‚’ã”å­˜çŸ¥ã®æ–¹ã¯ã€ãƒžã‚µã‚«ãƒªã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™

https://speakerdeck.com/twada/growing-reliable-code-phperkaigi-2022

https://speakerdeck.com/kazatohiei/phperkaigi2022?slide=33

https://zenn.dev/ysit/articles/github-actions-test-summary

# ã‚„ã‚Šæ–¹

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¾ã™

ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’å…¨ã¦è¡¨ç¤ºã™ã‚‹ã¨è¦‹ã¥ã‚‰ã„ã®ã§å¿…è¦ãªç®‡æ‰€ã ã‘ã‚’åˆ‡ã‚Šå–ã‚Šã—ã¦PRã‚³ãƒ¡ãƒ³ãƒˆã«å‡ºåŠ›ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-04-13 1.05.05.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/39fd7965-6516-fa12-6735-c8b5807ec9c6.png)

## ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¦‹ãŸã„å ´åˆ

å‡ºåŠ›å½¢å¼ã¯ã„ãã¤ã‹ã‚ã‚‹ã®ã§å…¬å¼ã‚’å‚è€ƒã«è¨­å®šãã ã•ã„

https://phpunit.readthedocs.io/ja/latest/textui.html#textui-clioptions

HTMLå½¢å¼ã§å‡ºåŠ›ã—ãŸã„å ´åˆã¯ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã‚’Laravelã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œã—ã¦ãã ã•ã„

```bash
phpdbg -qrr ./vendor/bin/phpunitã€€--coverage-html ./coverage
``` 

## è§£èª¬

MySQLã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•å¾Œã€å®Ÿè¡Œã™ã‚‹ã¾ã§ã«æ™‚é–“ã‚’è¦ã—ã¾ã™ãŒãƒ†ã‚¹ãƒˆãŒå…ˆã«é–‹å§‹ã•ã‚Œã‚‹ã¨`Connection Refused`ã§æŽ¥ç¶šãŒã§ãã¾ã›ã‚“ã€‚

ä»Šå›žã¯3åˆ†å¼±æ™‚é–“ã‚’ç½®ã„ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ã«é€²ã‚ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã—ãŸ

https://stackoverflow.com/questions/62446815/docker-mysql-github-actions-connection-refused

```yml
docker-compose exec -T laravel bash -c "sleep 200"
```

ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œå¥‘æ©Ÿã‚’è¨­å®šã—ã¾ã™

ä»Šå›žã¯`main`ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®šã—ã¾ã™

```yml
on:
  # PRå¥‘æ©Ÿ
  pull_request:
    branches: [ main ]
```


```yml:.github/workflows/test.yml
name: PhpUnitCoverage

on:
  # PRå¥‘æ©Ÿ
  pull_request:
    branches: [ main ]

jobs:
  build:
    # å®Ÿè¡Œç’°å¢ƒ
    runs-on: ubuntu-latest
    steps:
      # $GITHUB_WORKSPACEé…ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ã¦ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
      - uses: actions/checkout@v2

      - name: dokcer-compose Laravel Init
        run: |
          docker-compose up -d
          docker-compose exec -T laravel bash -c "composer install"
          docker-compose exec -T laravel bash -c "cp .env.example .env"
          docker-compose exec -T laravel bash -c "php artisan key:generate"
          docker-compose exec -T laravel bash -c "php artisan config:cache"
          docker-compose exec -T laravel bash -c "sleep 200"

      - name: Exec Phpunit
        run: |
          docker-compose exec -T laravel bash -c "phpdbg -qrr ./vendor/bin/phpunit --coverage-text --colors=never > storage/logs/coverage.log"
          docker-compose exec -T laravel bash -c "cat storage/logs/coverage.log"

      - name: Cat Test Result
        run: |
          cat ./src/laravel/storage/logs/coverage.log
        if: ${{ failure() }}

      - name: Sed Coverage Report
        run: |
          sed -E "s/"$'\E'"\[([0-9]{1,2}(;[0-9]{1,2})*)?m//g" | \
          grep "Code Coverage Report:" -A6 ./src/laravel/storage/logs/coverage.log | sed -e "s/^ *//" | sed -e "s/ *$//" | sed -e "/^ *$/d" > ./src/laravel/storage/logs/coverage-summary.log

      - name: Read coverage summary
        id: coverage-summary
        uses: juliangruber/read-file-action@v1
        with:
          path: ./src/laravel/storage/logs/coverage-summary.log

      - name: Comment Coverage Summary
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          header: coverage-summary
          message: |
            ## Coverage Summary
            ${{ steps.coverage-summary.outputs.content }}
```
