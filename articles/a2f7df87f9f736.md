---
title: "ã€TypeScript + NestJSã€‘crypto-jsã§è¤‡åˆåŒ–ã™ã‚‹ã¨Malformed UTF-8 data ã«ãªã£ãŸä»¶"
emoji: "ğŸ’¬"
type: "tech"
topics:
  - "typescript"
  - "npm"
  - "nestjs"
published: true
published_at: "2022-05-27 00:42"
---

# æ¦‚è¦

æš—å·åŒ–ã—ãŸæ–‡å­—åˆ—ã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚»ãƒƒãƒˆã—ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨é€å—ä¿¡ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸ

ã“ã®è¨˜äº‹ã¯ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆã¾ã§ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ®‹ã™ã‚‚ã®ã§ã™

https://www.npmjs.com/package/crypto-js

```bash
error    Malformed UTF-8 data
```


# ç’°å¢ƒ

- npm 6.14.13
- typescript ^4.2.3
- crypto-js 4.1.1


# æœ¬é¡Œ

GitHubã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹é€šã‚Šã«å®Ÿè£…ã—ã¦ã¿ãŸãŒå†’é ­ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã¾ã—ãŸã€‚


https://github.com/brix/crypto-js

```ts
var CryptoJS = require("crypto-js");

// Encrypt
var ciphertext = CryptoJS.AES.encrypt('my message', 'secret key 123').toString();

// Decrypt
var bytes  = CryptoJS.AES.decrypt(ciphertext, 'secret key 123');
var originalText = bytes.toString(CryptoJS.enc.Utf8);

console.log(originalText); // 'my message'
```

## è§£æ¶ˆæ–¹æ³•

ãƒã‚¤ãƒ³ãƒˆã¯è¤‡åˆç”¨ã®ç§˜å¯†éµã‚’`Latin1` ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ã§ã—ãŸ

ãƒ‡ãƒ¼ã‚¿ãŒ`ISO-8859-1` ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ãŸã“ã¨ã‹ã‚‰`UTF-8`ã§ã¯`parse`ã§ããªã„ã‚ˆï¼ï¼

ã¨ã®ã“ã¨ã§ã™ã€‚ã€‚

ã¡ãªã¿ã«`Issues`ã«ã‚‚ä¸ŠãŒã£ã¦ã„ãŸãŒç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã§ã¯è§£æ±ºã—ãªã‹ã£ãŸã®ã§ã€ä»Šå›ã®è§£æ¶ˆæ–¹æ³•ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãŠãã¾ã—ãŸã€‚

https://github.com/brix/crypto-js/issues/271


### è§£æ±ºã—ãŸã‚³ãƒ¼ãƒ‰ 

```ts:src/utilities/CustomCryptoJs.ts
public getEncodePath(decodePath: string): string {
    const json = CryptoJS.AES.encrypt(
        JSON.stringify(decodePath),
        this.SECRET_KEY
    ).toString()

    return CryptoJS.enc.Base64.stringify(CryptoJS.enc.Latin1.parse(json))
}

public getDecodePath(encodePath: string): string {
    const decodePath = decodeURIComponent(encodePath)

    const data = CryptoJS.enc.Base64.parse(decodePath.toString()).toString(
        CryptoJS.enc.Latin1
    )

    const bytes = CryptoJS.AES.decrypt(data, this.SECRET_KEY).toString(
        CryptoJS.enc.Utf8
    )

    return JSON.parse(bytes)
}
```
