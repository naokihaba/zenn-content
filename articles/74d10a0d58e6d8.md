---
title: "GitHub Actionsã§GitHub Packagesã‚’è‡ªå‹•ã§ç®¡ç†ã™ã‚‹æ–¹æ³•"
emoji: "ğŸš€"
type: "tech"
topics:
  - "githubactions"
  - "githubpackages"
published: false
published_at: "2021-11-28 19:16"
---

# æ¦‚è¦

ã“ã¡ã‚‰ã®ç¶šç·¨ã§ã™ã€‚
https://zenn.dev/naonao70/articles/17036b2a85e178


GitHub Actionsã®workflowsã‚’åˆ©ç”¨ã—ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚„ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’è‡ªå‹•çš„ã«ä½œæˆã™ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚Šã¾ã—ãŸ

## ã‚„ã‚Šæ–¹

ä»¥ä¸‹ã§ä½œæˆã—ãŸãƒªãƒã‚¸ãƒˆãƒªã§ä½œæ¥­ã‚’è¡Œã„ã¾ã™
https://zenn.dev/naonao70/articles/17036b2a85e178

## ä»¥ä¸‹ã®æ‰‹é †ã‚’æ‰‹å‹•ã§è¡Œã†ã®ã¯æ‰‹é–“ãªã®ã§è‡ªå‹•åŒ–ã—ã¦ã„ãã¾ã™

```mermaid
graph TB
    A[ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ›´æ–°] --> B(ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹)
    B --> C{npm publishã™ã‚‹}
    C -->|ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’ä½œæˆ| D[å®Œäº†]
    C -->|ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°ã‚’ä½œæˆ| E[å®Œäº†]
```

## workflowsã‚’å®šç¾©ã—ã¾ã™

```yml:.github/workflows/main.yml

# ä»»æ„ã®workflowåã‚’å…¥åŠ›ã—ã¾ã™
name: GitHub Packages Publish

on:
  # pushã™ã‚‹ã¨è‡ªå‹•çš„ã«å‹•ä½œã™ã‚‹
  push:
  # å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ
    branches:
      - master

jobs:
  setup:
    name: setup
    # Ubuntuæœ€æ–°ç‰ˆç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹
    runs-on: ubuntu-latest

    # ã‚¸ãƒ§ãƒ–ã«ä¾å­˜ã—ã¦ã„ã‚‹ã™ã¹ã¦ã®ä¸‹æµã®ã‚¸ãƒ§ãƒ–ã‹ã‚‰åˆ©ç”¨ã™ã‚‹
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      tag-name: v${{ steps.package-version.outputs.version }}
      is-pre-verion: ${{ steps.pre-version.outputs.pre-version }}
      tag-exist: ${{ steps.tag-exist.outputs.exists }}

    steps:
        # ã™ã¹ã¦ã®ã‚¿ã‚°ã¨ãƒ–ãƒ©ãƒ³ãƒã®ã™ã¹ã¦ã®å±¥æ­´ã‚’å–å¾—
      - name: checkout
        uses: actions/checkout@v2

      - name: setup Node
        uses: actions/setup-node@v2
        with:
          node-version: '14'
          registry-url: "https://npm.pkg.github.com"

      - name: set package version
        id: package-version
        # node -p çµæœã‚’å‡ºåŠ› -e æ¸¡ã—ãŸæ–‡å­—åˆ—ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦å®Ÿè¡Œ
        # å‡ºåŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¨­å®š '`::set-output name=version::${require("./package.json").version}`'
        run: node -p -e '`::set-output name=version::${require("./package.json").version}`'

      - name: check pre-release
        # ç¯„å›²æŒ‡å®šæœ‰ç„¡ã®åˆ¤å®š
        id: pre-version
        run: node -p -e '`::set-output name=pre-version::${require("./package.json").version.includes("-")}`'

        # ã‚¿ã‚°ãŒå­˜åœ¨ã™ã‚‹ã‹ã‚’åˆ¤å®š
      - name: check tag exists
        uses: mukunku/tag-exists-action@v1.0.0
        id: check-tag
        with:
          tag: ${{ steps.package-version.outputs.version }}
        # å…¨ã¦ã®stepsã‹ã‚‰å‚ç…§ã§ãã‚‹
        env:
          # æœ€ä½é™ã®æ¨©é™ã§å®Ÿè¡Œã™ã‚‹
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    name: publish
    # ã“ã®ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œå‰ã«æ­£å¸¸ã«å®Œäº†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚¸ãƒ§ãƒ–
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: setup Node
        uses: actions/setup-node@v2
        with:
          node-version: 14.x
          registry-url: "https://npm.pkg.github.com"

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - name: Cache node modules
        uses: actions/cache@v2
        with:
          # npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¯ Linux/macOS ã® `~/.npm` ã«ä¿å­˜ã•ã‚Œã‚‹
          path: ~/.npm
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-
            ${{ runner.os }}-node-
            ${{ runner.os }}-

      # npm publishã™ã‚‹
      - name: publish
        # npx can-npm-publish --verbose npm publishå¯èƒ½ã‹ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
        # https://efcl.info/2018/06/21/can-npm-publish/
        run: |
          npx can-npm-publish --verbose && npm publish || echo "Does not publish"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ã‚¿ã‚°ã‚’ä½œæˆã™ã‚‹
      - name: package-version-to-git-tag
        uses: pkgdeps/git-tag-action@v2
        with:
          # ä»¥ä¸‹ã¯é­”æ³•ã®å‘ªæ–‡çš„ãªãŠæ±ºã¾ã‚Š
          github_token: ${{ secrets.GITHUB_TOKEN }}
          github_repo: ${{ github.repository }}
          version: ${{ needs.setup.outputs.version }}
          git_commit_sha: ${{ github.sha }}
          # ã‚¿ã‚°å
          git_tag_prefix: "v"

  release-note:
    name: release note
    needs: [setup, publish]
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v1
      - name: setup Node
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
          registry-url: "https://npm.pkg.github.com"

      # ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆã‚’è‡ªå‹•ä½œæˆ
      - name: set change log
        uses: scottbrenner/generate-changelog-action@master
        id: change-log
      - name: Create a GitHub release
        uses: actions/create-release@v1
        if:  needs.setup.outputs.tag-exist != 'true' && needs.setup.outputs.is-pre-verion != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.setup.outputs.tag-name }}
          release_name: Release ${{ needs.setup.outputs.tag-name }}
          body: ${{ steps.change-log.outputs.changelog }}
```

## package.jsonã®"version"ã‚’1.0.1ã«æ›´æ–°ã—ã¾ã™

```json:package.json

{
  "name": "@ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå/ãƒªãƒã‚¸ãƒˆãƒªå",
  "version": "1.0.1",
  "repository": {
    "type": "git",
    // GitHubãƒªãƒã‚¸ãƒˆãƒªã‚’Cronã™ã‚‹éš›ã®HTTPS
    "url": "https://github.com/xxx/test.git",
    "directory": "GitHub-Packages-sample"
  }
}
```

## ã“ã“ã¾ã§ã®å‡¦ç†å†…å®¹ã‚’mainãƒ–ãƒ©ãƒ³ãƒã«pushã—ã¾ã™

```bash:bash
git add .
git commit -m "feat:åˆã‚ã¦ã®GitHubActions"
git push
```
