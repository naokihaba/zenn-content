---
title: "ã€Laravel8.xã€‘Laravel + Ngram + Observerã‚’åˆ©ç”¨ã—ãŸå…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…ãƒãƒ³ã‚ºã‚ªãƒ³"
emoji: "ğŸ“–"
type: "tech"
topics:
  - "laravel"
  - "artisan"
  - "ngram"
  - "observer"
published: true
published_at: "2022-01-08 04:35"
---

# ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã¯ä»¥ä¸‹ã®ç¶šç·¨ã«ãªã‚Šã¾ã™ã€‚
https://qiita.com/naoki-haba/items/ace7a5d1e0d9d72ed040

## ç¶šç·¨è¨˜äº‹ã‚’æ›¸ãã“ã¨ã«ã—ãŸçµŒç·¯

ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ†ãƒ¼ãƒ–ãƒ«æ§‹æˆã®å ´åˆã¯ä»¥ä¸‹ã®é€šã‚Šã«ã™ã‚Œã°å…¨æ–‡æ¤œç´¢ã®æº–å‚™ã¯æ•´ã„ã¾ã™

```php
DB::statement("ALTER TABLE shops ADD free_word TEXT as (concat(IFNULL(age, ''), ' ',IFNULL(name, ''), ' ',(case gender_id when 1 then 'ç”·æ€§' when 2 then 'å¥³æ€§' else '' end), ' ')) STORED");
```

ã—ã‹ã—ã€è¤‡é›‘ãªè¦å› ï¼ˆè¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®å¤–éƒ¨çµåˆãŒå¿…è¦ãªå ´åˆetc)ã®å ´åˆã«ã€ä¸Šè¨˜ã®è¨˜è¿°ã‚’ã™ã‚‹ã“ã¨ã«è‹¦åŠ´ã—ãŸã®ã§ã€ä»Šå›ã¯å¯¾å‡¦æ–¹æ³•ã®é¸æŠè‚¢ã®1ã¤ã¨ã—ã¦ã”ç´¹ä»‹ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚

# è¨˜äº‹ã®æµã‚Œ

1.æ—¢å­˜ã®DDLã‹ã‚‰`free_word`ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã™ã‚‹
2.ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹
3.`free_word`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹
4.`ç™»éŒ²`ãƒ»`æ›´æ–°`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹
5.`Artisan`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã™ã‚‹
6.ä½œæˆã—ãŸ`Artisan`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦`free_word`ã‚«ãƒ©ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹

# äº‹å‰æº–å‚™

https://github.com/nao-haba-dev/ngram-docker-observer-laravel/tree/master

```bash
docker-compose up -d
docker-compose exec app bash
composer install
composer update
cp .env.example .env
php artisan key:generate
php artisan storage:link
chmod -R 777 storage bootstrap/cache
```

http://localhost:8080/

# Laravel + Ngram + Observerã‚’åˆ©ç”¨ã—ãŸå…¨æ–‡æ¤œç´¢æ©Ÿèƒ½ã®å®Ÿè£…ãƒãƒ³ã‚ºã‚ªãƒ³

## 1.æ—¢å­˜ã®DDLã‹ã‚‰`free_word`ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã™ã‚‹

å¤‰æ›´ç”¨ã®`migration`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™

```bash
php artisan make:migration change_free_word_to_shops --table=shops
```

`migration`ã‚’å®šç¾©

```php:backend/database/migrations/2022_01_06_185439_change_free_word_to_shops.php
class ChangeFreeWordToShops extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('shops', function (Blueprint $table) {
            $table->dropColumn('free_word');
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('shops', function (Blueprint $table) {
            DB::statement("ALTER TABLE shops ADD free_word TEXT as (concat(IFNULL(age, ''), ' ',IFNULL(name, ''), ' ',(case gender_id when 1 then 'ç”·æ€§' when 2 then 'å¥³æ€§' else '' end), ' ')) STORED");
        });
    }
```

https://readouble.com/laravel/8.x/ja/migrations.html

`migration`ã‚’å®Ÿè¡Œã™ã‚‹

```bash
php artisan migrate
```

DDLã‚’ç¢ºèªã—,`shops`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`free_word`ã‚«ãƒ©ãƒ ãŒãªã‘ã‚Œã°OKã§ã™

```bash:ngram-docker-laravel 
docker-compose exec db bash

mysql -u root -p
Enter password: password

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| laravel_local      |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

mysql> use laravel_local;

mysql> show tables;
+-------------------------+
| Tables_in_laravel_local |
+-------------------------+
| failed_jobs             |
| migrations              |
| password_resets         |
| personal_access_tokens  |
| shops                   |
| users                   |
+-------------------------+
6 rows in set (0.00 sec)

 DESC shops;
+------------+-----------------+------+-----+-------------------+-----------------------------------------------+
| Field      | Type            | Null | Key | Default           | Extra                                         |
+------------+-----------------+------+-----+-------------------+-----------------------------------------------+
| id         | bigint unsigned | NO   | PRI | NULL              | auto_increment                                |
| name       | varchar(255)    | NO   |     | NULL              |                                               |
| age        | int unsigned    | NO   |     | NULL              |                                               |
| gender_id  | smallint        | NO   |     | NULL              |                                               |
| created_at | timestamp       | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED                             |
| updated_at | timestamp       | NO   |     | CURRENT_TIMESTAMP | DEFAULT_GENERATED on update CURRENT_TIMESTAMP |
+------------+-----------------+------+-----+-------------------+-----------------------------------------------+
6 rows in set (0.01 sec)
```

## 2.ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹

å®Ÿè¡Œã™ã‚‹`Seed`ãƒ•ã‚¡ã‚¤ãƒ«


```php:backend/database/seeders/DummyShopsSeeder.php
<?php

namespace Database\Seeders;

use App\Models\Shop;
use Illuminate\Database\Seeder;

class DummyShopsSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * @return void
     */
    public function run()
    {
        $data = [
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ',
                'age' => 25,
                'gender_id' => 1
            ],
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«èŠ±å­',
                'age' => 30,
                'gender_id' => 2
            ],
            [
                'name' => 'ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ',
                'age' => 20,
                'gender_id' => 1
            ],
        ];

        (new Shop())->query()->insert($data);
    }
}
```

`Seed`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ

```bash
 php artisan db:seed --class=DummyShopsSeeder
```

`Seed`çµæœã‚’ç¢ºèªã—ç™»éŒ²ã§ãã¦ã„ã‚Œã°æˆåŠŸã§ã™

```bash
mysql> select * from shops;
+----+--------------------+-----+-----------+---------------------+---------------------+
| id | name               | age | gender_id | created_at          | updated_at          |
+----+--------------------+-----+-----------+---------------------+---------------------+
|  1 | ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ       |  25 |         1 | 2022-01-07 04:19:43 | 2022-01-07 04:19:43 |
|  2 | ã‚µãƒ³ãƒ—ãƒ«èŠ±å­       |  30 |         2 | 2022-01-07 04:19:43 | 2022-01-07 04:19:43 |
|  3 | ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ       |  20 |         1 | 2022-01-07 04:19:43 | 2022-01-07 04:19:43 |
+----+--------------------+-----+-----------+---------------------+---------------------+
3 rows in set (0.01 sec)
```

## 3.`free_word`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹

å†åº¦`free_word`ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹`migration`ã‚’ä½œæˆã—ã¾ã™

```bash
php artisan make:migration add_free_word_column_to_shops --table=shops
```

`migration`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®šç¾©ã—ã¾ã™

```php:backend/database/migrations/2022_01_07_162519_add_free_word_column_to_shops.php
class AddFreeWordColumnToShops extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('shops', function (Blueprint $table) {
            DB::statement("ALTER TABLE shops ADD free_word TEXT");
            DB::statement("ALTER TABLE shops ADD FULLTEXT index ftx_free_word (free_word) with parser ngram");
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('shops', function (Blueprint $table) {
            $table->dropColumn('free_word');
        });
    }
}
```

`migration`ã‚’å®Ÿè¡Œã™ã‚‹

```bash
php artisan migrate
```

DDLã‚’ç¢ºèªã—`shops`ãƒ†ãƒ¼ãƒ–ãƒ«ã«`free_word`ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚Œã°OKã§ã™


```bash:ngram-docker-laravel 
docker-compose exec db bash

mysql -u root -p
Enter password: password

mysql> show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| laravel_local      |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

mysql> use laravel_local;

mysql> show tables;
+-------------------------+
| Tables_in_laravel_local |
+-------------------------+
| failed_jobs             |
| migrations              |
| password_resets         |
| personal_access_tokens  |
| shops                   |
| users                   |
+-------------------------+
6 rows in set (0.00 sec)

mysql> select * from shops;
+----+--------------------+-----+-----------+---------------------+---------------------+-----------+
| id | name               | age | gender_id | created_at          | updated_at          | free_word |
+----+--------------------+-----+-----------+---------------------+---------------------+-----------+
|  1 | ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ       |  25 |         1 | 2022-01-08 01:54:17 | 2022-01-08 01:54:17 | NULL      |
|  2 | ã‚µãƒ³ãƒ—ãƒ«èŠ±å­       |  30 |         2 | 2022-01-08 01:54:17 | 2022-01-08 01:54:17 | NULL      |
|  3 | ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ       |  20 |         1 | 2022-01-08 01:54:17 | 2022-01-08 01:54:17 | NULL      |
+----+--------------------+-----+-----------+---------------------+---------------------+-----------+

```

## 4.`ç™»éŒ²`ãƒ»`æ›´æ–°`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã™ã‚‹å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹

ã•ã¦,ã“ã“ã¾ã§ã§å…¨æ–‡æ¤œç´¢ç”¨ã®ã‚«ãƒ©ãƒ ã®ä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚
ã§ã™ãŒè¦‹ã¦ã®é€šã‚Š`free_word`ã‚«ãƒ©ãƒ ã¯`NULL`ãªã®ã§ã“ã‚Œã§ã¯å…¨æ–‡æ¤œç´¢ãŒã§ãã¾ã›ã‚“ã€‚
ãã“ã§ã€`ç™»éŒ²`ãƒ»`æ›´æ–°`ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ‡ã‚£ã‚¹ãƒ‘ãƒƒãƒã—ã¦è‡ªå‹•çš„ã«`free_word`ã‚«ãƒ©ãƒ ã«è¿½åŠ ã™ã‚‹å€¤ã‚’ç”Ÿæˆã—ã¦ã„ãã¾ã™

https://qiita.com/naoki-haba/items/e8eae3e67267eacfdfff

### ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã¾ã™

```bash
php artisan make:observer ShopObserver --model=Shop
```

### ã‚ªãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’å®šç¾©

```php::backend/app/Observers/ShopObserver.php
<?php

namespace App\Observers;

use App\Models\Shop;

class ShopObserver
{
    /**
    * save()ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œçŸ¥ã™ã‚‹
    * @param Shop $shop
    * @return void
    */
    public function saved(Shop $shop)
    {
        $collect = collect($shop);
        $id = $collect->get('id');
        $name = $collect->get('name');
        $age = $collect->get('age');
        $genderId = $collect->get('gender_id');

        if (!is_null($genderId)) {
            $gender = (int)$genderId === 1 ? 'ç”·æ€§' : 'å¥³æ€§';
        } else {
            $gender = null;
        }

        $freeWord = $age . ' ' . $id . ' ' . $name . ' ' . $gender;

        $data = [
            'id' => $id,
            'name' => $name,
            'age' => $age,
            'gender_id' => $genderId,
            'free_word' => $freeWord,
        ];

        (Shop::query()->where('id', $id))->update($data);
    }
}
```

### ã‚ªãƒ–ã‚µãƒ¼ãƒãƒ¼ã‚’ç™»éŒ²

```php:backend/app/Providers/EventServiceProvider.php
class EventServiceProvider extends ServiceProvider
{
    /**
     * The event listener mappings for the application.
     *
     * @var array<class-string, array<int, class-string>>
     */
    protected $listen = [
        Registered::class => [
            SendEmailVerificationNotification::class,
        ],
    ];

    /**
     * Register any events for your application.
     *
     * @return void
     */
    public function boot()
    {
        Shop::observe(ShopObserver::class);
    }
}
```

## 5.`Artisan`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½œæˆã™ã‚‹

https://readouble.com/laravel/8.x/ja/artisan.html

###  ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ

```bash
php artisan make:command UpdateFreeWordByShop
```

### ã‚³ãƒãƒ³ãƒ‰å®šç¾©

```php
class UpdateFreeWordByShop extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = 'update:free-word-by-shop';

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = 'shopsãƒ†ãƒ¼ãƒ–ãƒ«ã®free_wordã‚’ç™»éŒ²ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰';

    /**
     * Create a new command instance.
     *
     * @return void
     */
    public function __construct()
    {
        parent::__construct();
    }

     /**
     * Execute the console command.
     *
     * @return void
     */
    public function handle()
    {
        $updateTarget = Shop::query()->pluck('id');

        foreach ($updateTarget as $id) {
            $target = Shop::find($id);
            $result = $target->save();

            if (!$result) {
                echo "åº—ID:{$id}ã®ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚çµ‚äº†ã—ã¾ã™\n";
                exit();
            }

            echo "{$id}å®Œäº†\n";

        }

        echo "å‡¦ç†å®Œäº†ã€‚çµ‚äº†ã—ã¾ã™ã€‚\n";
        exit();
    }
}
```

## 6.ä½œæˆã—ãŸ`Artisan`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦`free_word`ã‚«ãƒ©ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹

### ä½œæˆã—ãŸã‚³ãƒãƒ³ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

```bash
php artisan

update
  update:free-word-by-shop  shopsãƒ†ãƒ¼ãƒ–ãƒ«ã®free_wordã‚’ç™»éŒ²ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
```

### ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

```bash
php artisan update:free-word-by-shop
1å®Œäº†
2å®Œäº†
3å®Œäº†
å‡¦ç†å®Œäº†ã€‚çµ‚äº†ã—ã¾ã™ã€‚
```

### `free_word`ã«ãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèª

`free_word`ã«å€¤ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°æˆåŠŸã§ã™ï¼

```bash
mysql> select * from shops;
+----+--------------------+-----+-----------+---------------------+---------------------+--------------------------------+
| id | name               | age | gender_id | created_at          | updated_at          | free_word                      |
+----+--------------------+-----+-----------+---------------------+---------------------+--------------------------------+
|  1 | ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ       |  25 |         1 | 2022-01-08 01:54:17 | 2022-01-07 19:25:39 | 25 1 ã‚µãƒ³ãƒ—ãƒ«å¤ªéƒ ç”·æ€§         |
|  2 | ã‚µãƒ³ãƒ—ãƒ«èŠ±å­       |  30 |         2 | 2022-01-08 01:54:17 | 2022-01-07 19:25:39 | 30 2 ã‚µãƒ³ãƒ—ãƒ«èŠ±å­ å¥³æ€§         |
|  3 | ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ       |  20 |         1 | 2022-01-08 01:54:17 | 2022-01-07 19:25:39 | 20 3 ã‚µãƒ³ãƒ—ãƒ«äºŒéƒ ç”·æ€§         |
+----+--------------------+-----+-----------+---------------------+---------------------+--------------------------------+
3 rows in set (0.00 sec)
```

# ãŠã‚ã‚Šã«

èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚
ä»Šå›ã®è¨˜äº‹ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ
ãƒ»ã“ã†ã„ã†è¨˜äº‹ãŒèª­ã¿ãŸã„
ãƒ»ã“ã†ã„ã†ã¨ã“ã‚ãŒè‰¯ã‹ã£ãŸ
ãƒ»ã“ã†ã—ãŸæ–¹ãŒè‰¯ã„ã®ã§ã¯ãªã„ã‹
ãªã©ãªã©ã€ç‡ç›´ãªã”æ„è¦‹ã‚’å‹Ÿé›†ã—ã¦ãŠã‚Šã¾ã™ã€‚
