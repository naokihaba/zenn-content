---
title: "ã€NestJSã€‘Hasuraãƒ»NestJSã‚’Auth0ã§èªè¨¼å‡¦ç†ã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸš€"
type: "tech"
topics:
  - "graphql"
  - "hasura"
  - "nestjs"
  - "auth0"
published: true
published_at: "2022-08-20 02:29"
---

# æ¦‚è¦

ã“ã®è¨˜äº‹ã§ã¯`NestJS`ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨`Hasura`ã«å¯¾ã™ã‚‹èªè¨¼ã‚’æ‹…ã†ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã—ã¦`Auth0`ã‚’æ¡ç”¨ã—ãŸéš›ã®å°å…¥æ–¹æ³•ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã¦ã„ã¾ã™

https://auth0.com/jp/authentication


# `Hasura`ã‚’`Auth0`ã§ä¿è­·ã™ã‚‹æ–¹æ³•

åŸºæœ¬çš„ã«ã¯`hasura`ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒå……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ãã®é€šã‚Šã«é€²ã‚ã‚Œã°è¨­å®šã¯å®Œäº†ã—ã¾ã™

https://hasura.io/learn/ja/graphql/hasura/introduction/

`Docker`ã§ç’°å¢ƒæ§‹ç¯‰ã‚’ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯`AUth0`ã®å…¬é–‹éµã‚’ç™ºè¡Œã—ã¦ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™

https://hub.docker.com/r/hasura/graphql-engine

## ç’°å¢ƒå¤‰æ•°ã«å…¬é–‹éµã‚’è¨­å®šã™ã‚‹

### å…¬é–‹éµã®ç™ºè¡Œ

ã“ã¡ã‚‰ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹é€šã‚Šå…¬é–‹éµã‚’ç™ºè¡Œã—ã¦ãã ã•ã„

https://hasura.io/learn/ja/graphql/hasura/authentication/3-setup-env-vars-hasura/

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

```yaml:docker-compose.yaml
version: '3.6'
services:
  postgres:
    image: postgres
    restart: always
    volumes:
    - db_data:/var/lib/postgresql/data
  graphql-engine:
    image: hasura/graphql-engine:v1.0.0-beta.6
    ports:
    - "8080:8080"
    depends_on:
    - "postgres"
    restart: always
    environment:
      HASURA_GRAPHQL_DATABASE_URL: postgres://postgres:@postgres:5432/postgres
      HASURA_GRAPHQL_ENABLE_CONSOLE: "true" # set to "false" to disable console
      ## uncomment next line to set an admin secret
      # HASURA_GRAPHQL_ADMIN_SECRET: myadminsecretkey
      # HASURA_GRAPHQL_JWT_SECRET: 'ç™ºè¡Œã—ãŸå…¬é–‹éµã‚’å®šç¾©ã—ã¾ã™'
volumes:
  db_data:
```


# `NestJS`ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä¿è­·

åŸºæœ¬çš„ã«`NestJS`ã§ã¯`Hasura`ã§å¸åã§ããªã„è¤‡é›‘ãªå‡¦ç†ã®ã¿ã‚’æ‹…ã£ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚
Hasuraã‚’çµŒç”±ã™ã‚‹å ´åˆã¯å‰è¿°ã®`Hasura`ã®ä¿è­·ã§ã‚»ã‚­ãƒ¥ã‚¢ã«ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚
ãã“ã§`NestJS`å´ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ç›´æ¥å©ã‹ã‚Œãªã„ã‚ˆã†ã«åŒæ§˜ã«`Auth0`ã§ä¿è­·ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## èªè¨¼ã§åˆ©ç”¨ã™ã‚‹å€¤ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š

`.env`ã«ç›´æ¥æ›¸ãã‚ˆã‚Š`GCP`ã®`Cloud Run`ã®`Secret`ã§ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã—ã¦ãŠãæ–¹ãŒã‚ˆã•ãã†ã§ã™ãŒã€ä¸€æ—¦ã“ã¡ã‚‰ã«å®šç¾©ã—ã¦ã„ã¾ã™

```:.env
# DomainName 
AUTH0_ISSUER_URL="https://xxxx.auth0.com/"

# Identifier
AUTH0_AUDIENCE="xxxxx"
```

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‰ã®`Guard`æ©Ÿèƒ½ã‚’å®Ÿè£…

ç‰¹å®šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æœ¬å½“ã«é€šã—ã¦è‰¯ã„ã®ã‹ã‚’æ¤œè¨¼ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¦ã„ãã¾ã™

> å®Ÿè¡Œæ™‚ã«å­˜åœ¨ã™ã‚‹ç‰¹å®šã®æ¡ä»¶ (ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã€ãƒ­ãƒ¼ãƒ«ã€ACL ãªã©) ã«å¿œã˜ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ã«ã‚ˆã£ã¦å‡¦ç†ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’æ±ºå®šã—ã¾ã™ã€‚ã“ã‚Œã¯ã—ã°ã—ã°èªå¯ (authorization) ã¨å‘¼ã°ã‚Œã¾ã™ã€‚

https://docs.nestjs.com/guards

### `Guard`ã‚’ä½œæˆã™ã‚‹

https://docs.nestjs.com/cli/usages

```bash
# NestJS CLIã§ä½œæˆã—ã¾ã™
nest g gu auth/auth-guard
```

### `Guard`ã‚’å®šç¾©ã™ã‚‹

```ts:app/src/common/guard/auth/auth-guard.guard.ts
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  UnauthorizedException,
} from '@nestjs/common'
import { GqlContextType } from '@nestjs/graphql'
import { InjectPinoLogger, PinoLogger } from 'nestjs-pino'
import { Reflector } from '@nestjs/core'
import { expressjwt, GetVerificationKey } from 'express-jwt'
import { expressJwtSecret } from 'jwks-rsa'
import { ConfigService } from '@nestjs/config'
import { promisify } from 'util'

@Injectable()
export class AuthGuard implements CanActivate {
  private readonly AUTH0_AUDIENCE: string
  private readonly AUTH0_ISSUER_URL: string

  constructor(
    @InjectPinoLogger(AuthGuard.name) private readonly logger: PinoLogger,
    private readonly reflector: Reflector,
    private readonly configService: ConfigService,
  ) {
    this.AUTH0_AUDIENCE = this.configService.get('AUTH0_AUDIENCE')
    this.AUTH0_ISSUER_URL = this.configService.get('AUTH0_ISSUER_URL')
  }

  async canActivate(context: ExecutionContext): Promise<boolean> {
    if (context.getType<GqlContextType>() === 'graphql') {
      return true
    }

    // Auth0ã«å¯¾ã—ã¦JwtTokenã®æ•´åˆæ€§ã‚’ç¢ºèª
    const checkJwtToken = await promisify(
      expressjwt({
        secret: expressJwtSecret({
          cache: true,
          rateLimit: true,
          jwksRequestsPerMinute: 5,
          jwksUri: `${process.env.AUTH0_ISSUER_URL}.well-known/jwks.json`,
        }) as GetVerificationKey,
        audience: this.AUTH0_AUDIENCE,
        issuer: this.AUTH0_ISSUER_URL,
        algorithms: ['RS256'],
      }),
    )

    try {
      await checkJwtToken(
        context.switchToHttp().getRequest(),
        context.switchToHttp().getResponse(),
      )
      return true
    } catch (e: unknown) {
      throw new UnauthorizedException(e)
    }
  }
}
```

## `API`ã¸ã®ä¿è­·ã‚’æœ‰åŠ¹ã«ã—ã¾ã™

```ts:app/src/app.module.ts
import { HttpAdapterHost, NestFactory } from '@nestjs/core'
import { AppModule } from './app.module'
import { Logger } from 'nestjs-pino'
import { AllExceptionsFilter } from './common/filter/all-exceptions.filter'

async function bootstrap() {
  // nestjs-pino https://github.com/iamolegga/nestjs-pino
  const app = await NestFactory.create(AppModule, { bufferLogs: true })
  app.useLogger(app.get(Logger))

  const adapterHost = app.get(HttpAdapterHost)
  const httpAdapter = adapterHost.httpAdapter
  const instance = httpAdapter.getInstance()
  app.useGlobalFilters(new AllExceptionsFilter(instance))

  app.enableCors({
    origin: '*',
    allowedHeaders:
      'Origin, X-Requested-With, Content-Type, Accept, Authorization',
  })

  await app.listen(3000)
}
bootstrap()
```

## æ¤œè¨¼

`@UseGuards(AuthGuard)`ã§ä¿è­·ã—ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦`id_token`ä»˜ãã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã„ãã¾ã™

```ts:app/src/app.controller.ts
import { Controller, Get, UseGuards } from '@nestjs/common'
import { AppService } from './app.service'
import { AuthGuard } from './common/guard/auth/auth-guard.guard'

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello()
  }

  @UseGuards(AuthGuard)
  @Get('/private')
  async private() {
    return { message: 'æˆåŠŸã—ãŸãŠ' }
  }
}
```

## `Auth0` ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã¡ã‚‰ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸğŸ™‡â€â™‚ï¸

ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—æˆåŠŸã™ã‚‹ã¨`id_token`ãŒç™ºè¡Œã•ã‚Œã‚‹ã®ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãŠã

https://dev.classmethod.jp/articles/auth0-nestjs-backend-sample/

```sh
#!/usr/bin/env bash

auth_url=https://xxx.auth0.com
client_id=xxxx
client_secret=xxxx
username="Auth0ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ"
password="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"

echo "successğŸ id_tokenã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„"

curl -s --request POST \
  --url ${auth_url}/oauth/token \
  --header 'content-type: application/x-www-form-urlencoded' \
  --data grant_type=password \
  --data username=xxxx \
  --data password=xxxx \
  --data client_id=xxxx \
  --data client_secret=xxxx \
echo "\n"
```

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

æ­£å¸¸ã«`id_token`ã‚’æ¸¡ã™ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™

è©¦ã—ã«`id_token`ã®ä¸€éƒ¨ã‚’æ¶ˆã—ã¦å†åº¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã¨èªè¨¼ã«å¤±æ•—ã—ã¾ã™

```
curl -i -X GET 'http://localhost:3000/private' -H 'Authorization: Bearer id_token'
HTTP/1.1 200 OK X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json
charset=utf-8
Content-Length: 64
Connection: keep-alive
Keep-Alive: timeout=5
HTTP/1.1 200 OK
X-Powered-By: Express
Access-Control-Allow-Origin: *
Content-Type: application/json; charset=utf-8
Content-Length: 34
ETag: W/"22-hShrnoFIPYGoHz/Bm72qqTZK7ss"
Date: Fri, 19 Aug 2022 16:25:08 GMT
Connection: keep-alive
Keep-Alive: timeout=5

{"message":"æˆåŠŸã—ãŸãŠ"}
```


# ãŠã‚ã‚Šã«

ä»Šå›ã¯ç›´è¿‘ã§é–‹ç™ºã—ãŸå†…å®¹ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«å‚™å¿˜éŒ²ã¨ã—ã¦æ®‹ã—ã¾ã—ãŸã€‚
ã“ã‚Œã‹ã‚‰é–‹ç™ºã•ã‚Œã‚‹æ–¹ã€…ã®ãŠå½¹ã«ç«‹ã¦ã°å¹¸ã„ã§ã™
